
<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [["$","$"]]}
      });
    MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
      MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
        cancel: ["Extension","cancel"],
        bcancel: ["Extension","cancel"],
        xcancel: ["Extension","cancel"],
        cancelto: ["Extension","cancel"]
      });
    });
    </script>
   <script type="text/javascript"
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_HTML-full">
   </script>
   <link rel="stylesheet" type="text/css" media="screen" href="https://burakbayramli.github.io/css/style.css">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1548953794786292"
          crossorigin="anonymous"></script>  
  </head>
    <body>
      <div id="header_wrap" class="outer">
        <header class="inner">
          <h1 id="project_title">
            <a href="https://burakbayramli.github.io" style="text-decoration:none; color:inherit;">dersblog</a>
          </h1>
          <h2 id="project_tagline"></h2>          
        </header>
      </div>
      <div id="main_content_wrap" class="outer">        
        <section id="main_content" class="inner">
        <h1></h1>
<h1>Yol Bulmak, OSMNX</h1>

<p>OpenStreetMap dünya coğrafi verilerini içeren açık kaynak, herkesin
bilgi ekleyebildiği devasa bir kaynaktır, verisi açık, bedava olarak
paylaşılır. İçinde yollar, restoranlar, dükkanlar, önemli yerler gibi
pek çok coğrafi bilgileri içerir. Fakat veriyi işlemek bazıları için
zor olabilir.</p>

<p>Bu verinin daha rahat işlenmesini sağlayan bir paket OSMNX. Özellikle
yol ağ yapısını rahat şekilde indirilmesini ve çizit (graph) olarak
doğru şekilde gelmesini sağlıyor. Çizitler bilindiği gibi matematiğin
bir dalidir, bize düğüm-bağlantı yapılarını işleyen algoritmalar
sağlar, tabii ki bir yol ağı çizit teorisinin en bariz uygulama
alanıdır, düğümler duraklar, köşe başları vs olabilir bağlantılar
onlar arasındaki yollar olacaktır.</p>

<p>OSMNX sadece kullanicinin tanimladigi bolgeler icindeki yol yapisini
dondurme kabiliyetine sahiptir, ve bu veriyi diskte onbellekleme yaparak
saklayabilir, boylece ayni bolge icin sonraki yukleme cagrilarinin OSM'e
baglanmasi gerekmez. Örnek olarak [1]'deki şehre bakalım,</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">osmnx</span> <span class="k">as</span> <span class="nn">ox</span>

<span class="n">ox</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache_folder</span><span class="o">=</span><span class="s1">&#39;/tmp/osmnx&#39;</span><span class="p">)</span>

<span class="n">north</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">west</span> <span class="o">=</span> <span class="mf">37.79</span><span class="p">,</span> <span class="mf">37.78</span><span class="p">,</span> <span class="o">-</span><span class="mf">122.41</span><span class="p">,</span> <span class="o">-</span><span class="mf">122.43</span>

<span class="n">G</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">graph_from_bbox</span><span class="p">(</span><span class="n">north</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">west</span><span class="p">,</span> <span class="n">network_type</span><span class="o">=</span><span class="s2">&quot;walk&quot;</span><span class="p">)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;osmnx-01.jpg&#39;</span><span class="p">,</span><span class="n">quality</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</code></pre>
</div>

<p><img src="osmnx-01.jpg" alt="" /></p>

<p><code>cache_folder</code> ile önbellek dosyalarının yazılacağı yer tanımlanır. Üstteki çağrı
için baktık <code>30 520ecdb05972a5893b8a541266157cd0b30a6381.json</code> diye bir dosya
oraya yazılmış, büyüklüğü 1.8 MB. Fena değil. </p>

<p><code>graph_from_bbox</code> ile belli kuzey, güney, doğu, batı üç noktalarının
oluşturduğu kutunun içine düşen yol ağını aldık, fakat tek bir nokta
verip ona belli uzaklıktaki tüm yol ağını da alabilirdik, mesela
<code>graph_from_point((37.79, -122.41), dist=750</code> ile verili noktanın 750
metre çevresindeki ağ alınabilir.</p>

<p>Network tipi <code>network_type</code> ile <code>walk</code>, <code>drive</code>, <code>bıke</code> değerleri
geçilebiliyor, bu değerler sırasıyla arabaların geçebildiği, ya da
bisiklet, ya da yürünebilen yol yapılarını döndürecektir. Uygulamanın
ihtiyacına göre farklı değerler kullanılabilir.</p>

<p>Artık geri döndürülen <code>G</code> içinde yol yapısı var, buna düğümlerden
oluşan bir liste olarak erişilebilir, mesela 0'inci ve 20'inci
düğümler</p>

<div class="codehilite">
<pre><span></span><code><span class="nb">print</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">G</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">G</span><span class="p">)[</span><span class="mi">20</span><span class="p">])</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>65281835
65295347
</code></pre>
</div>

<p>İlk 10 düğüm</p>

<div class="codehilite">
<pre><span></span><code><span class="nb">print</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">G</span><span class="p">)[:</span><span class="mi">10</span><span class="p">])</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>[65281835, 65281838, 65282081, 65282083, 65282130, 65282133, 65282136, 65282140, 65282144, 65285109]
</code></pre>
</div>

<p>Kısa yol bulmaya gelelim; ilk önce eldeki başlangıç ve bitiş coğrafi
kordinatlarına en yakın çizit düğümlerini bulmak lazım,</p>

<div class="codehilite">
<pre><span></span><code><span class="n">origin</span> <span class="o">=</span> <span class="p">(</span><span class="mf">37.784825495166544</span><span class="p">,</span> <span class="o">-</span><span class="mf">122.40208526405367</span><span class="p">)</span>
<span class="n">destination</span> <span class="o">=</span> <span class="p">(</span><span class="mf">37.79584463577157</span><span class="p">,</span> <span class="o">-</span><span class="mf">122.40724290129684</span><span class="p">)</span>
<span class="n">origin_node</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">nearest_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">destination_node</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">nearest_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">destination</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">destination</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">origin_node</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">destination_node</span><span class="p">)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>5429618404
9835210340
</code></pre>
</div>

<p>Görülen iki kimlik değeri düğüm İD, bunlarla yine OSMNX içinde mevcut
olan en kısa yol algoritmasini işletiyoruz,</p>

<div class="codehilite">
<pre><span></span><code><span class="n">route</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">origin_node</span><span class="p">,</span> <span class="n">destination_node</span><span class="p">)</span>
<span class="n">route</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>Out[1]: 
[5429618404,
 5429618406,
 65343960,
 65333814,
 1580501206,
 65334120,
 65312401,
 65343962,
 65314158,
 10802171480]
</code></pre>
</div>

<p>Kısa yol bize bir düğüm İD listesi olarak donduruldu, yani en kısa yol
bu düğüm değerlerinden oluşuyor. Listedeki ilk düğümün bilgilerini <code>G</code>
çiziti üzerinden alabiliriz, </p>

<div class="codehilite">
<pre><span></span><code><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">route</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>Out[1]: {&#39;y&#39;: 37.7838048, &#39;x&#39;: -122.410132, &#39;street_count&#39;: 1}
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">coords</span> <span class="o">=</span> <span class="p">[[</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">],</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">route</span><span class="p">]</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>[[37.7838048, -122.410132], [37.7842485, -122.4102223], [37.7841515, -122.4109719], [37.7850815, -122.4111594], [37.7860145, -122.4113476], [37.7869469, -122.4115357], [37.7872177, -122.4115903], [37.7875647, -122.4116603], [37.7878756, -122.411723], [37.7880186, -122.4105956], [37.7882369, -122.4106376], [37.7883078, -122.4101224], [37.7884585, -122.4101529], [37.7885478, -122.410171], [37.7889453, -122.4102515], [37.7890203, -122.4102667], [37.7890994, -122.4102825], [37.7891123, -122.4101922], [37.7898919, -122.4103503], [37.7899644, -122.4103641]]
</code></pre>
</div>

<p>Kordinatları bir Folium haritasında gösterebiliriz artık,</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">folium</span>
<span class="nb">map</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span><span class="n">zoom_start</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">control_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">folium</span><span class="o">.</span><span class="n">PolyLine</span><span class="p">(</span><span class="n">locations</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span>
<span class="nb">map</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;direction1.html&#39;</span><span class="p">)</span>
</code></pre>
</div>

<p><a href="direction1.html">Tarif</a></p>

<p>Kaynaklar</p>

<p>[1] [Geoff Boeing](https://geoffboeing.com/2016/11/osmnx-python-street-networks/)</p>

<p>[2] [OSRM Yol Tarifi](../../2016/11/yol-tarifi-harita-bilgisi-osrm-backend.html)</p>

<p>[3] [NetworkX Multidigraph](https://networkx.org/documentation/stable/reference/classes/multidigraph.html)</p>

<p>[4] [OSMNX Belge 1](https://github.com/gboeing/osmnx-examples/blob/main/notebooks/01-overview-osmnx.ipynb)</p>

<p>[5] [OSMNX Belge 2](https://github.com/bryanvallejo16/shortest-path-osm/blob/main/shortest<em>path</em>osm<em>updated</em>example.ipynb)</p>

<p>[6] [OSMNX Belge 3](https://github.com/gboeing/osmnx-examples/blob/main/notebooks/02-routing-speed-time.ipynb)</p>

          <br/><a href="../index.html">Yukarı</a>
        </section>          
      </div>
    </body>
</html>
