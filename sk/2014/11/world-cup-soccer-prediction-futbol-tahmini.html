
<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [["$","$"]]}
      });
    MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
      MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
        cancel: ["Extension","cancel"],
        bcancel: ["Extension","cancel"],
        xcancel: ["Extension","cancel"],
        cancelto: ["Extension","cancel"]
      });
    });
    </script>
   <script type="text/javascript"
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_HTML-full">
   </script>
   <link rel="stylesheet" type="text/css" media="screen" href="https://burakbayramli.github.io/css/style.css">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1548953794786292"
          crossorigin="anonymous"></script>  
  </head>
    <body>
      <div id="header_wrap" class="outer">
        <header class="inner">
          <h1 id="project_title">
            <a href="https://burakbayramli.github.io" style="text-decoration:none; color:inherit;">dersblog</a>
          </h1>
          <h2 id="project_tagline"></h2>          
        </header>
      </div>
      <div id="main_content_wrap" class="outer">        
        <section id="main_content" class="inner">
        <h1></h1>
<h1>Dünya Kupası 2014, Veri Analizi</h1>

<p>Daha önceki maç verisine bakarak 2014 Dünya Kupası maçlarını tahmin
edebilen istatistik (yapay öğrenim) teknikleri Google mühendisleri
tarafından paylaşıldı, kullanılan teknik lojistik regresyon. Verinin
şekillendirilmesi, veriden özellik (feature) yaratmak işin püf
noktalarından - veri hangi detay seviyesinde (maç seviyesinde mi takım
seviyesinde mi) ve hangi kolonlar üzerinden modele dahil edilecek?
Görülüyor ki nihai regresyon her maç için iki takımı yanyana koyuyor
(A takımı öğeleri belli kolonlar B öğeleri belli kolonlar) ve 1,0
etiketini tahmine uğraşıyor. Öğelerin önemli bir özelliği o ana kadar
her iki takımın oynadığı önceki N maçın özeti olmaları. Yani A takımı
son 3 maçta (N=3) maçta dakikada 5 pas atmışsa passes öğesi 5
olacaktır, B takımı dakikada 10 atmışsa <code>op_passes</code> 10
olacaktır. Böylece lojistik regresyona 5'e karşı 10 pas ağırlığı olan
bir veri satırı hakkında irdeleme yapma imkanı veriyoruz; ve bilinen
etikete göre LR gerekli ağırlıkları hesaplayarak sonuca erişiyor.</p>

<p>Projede kullanılan 4 Python dosyası var: </p>

<p><code>match_stats</code>: Maç istatistiklerini yükleyen kodlar.</p>

<p><code>features</code>: Ham istatistik verileri özelliklere (features) döndürüyor,
ki bu özellikler yapay öğrenim modeline girilebilsin. Bu özellikler önceki
K maçın verilerini özetleme amaçlı yaratıldılar, ki bu özelliklere
dayanarak bir sonraki maçı tahmnin edebilelim.</p>

<p><code>world_cup</code>: Veriyi temizlemek ve modeli kurmak için kullanılan
yardımcı kodlar.</p>

<p><code>power</code>: Birbiriyle belli sayıda maç yapmış takımların bir ``güç
sıralamasını'' hesaplamak.</p>

<p>Özellik inşası</p>

<p>Sonraki maç tahmini için önceki K maçın özet istatistiklerine bakıyoruz, K'nın
ne olduğu <code>history_size</code> ile tanımlı.</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">world_cup</span>
<span class="kn">import</span> <span class="nn">features</span>
<span class="kn">import</span> <span class="nn">match_stats</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">history_size</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">game_summaries</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">get_game_summaries</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">get_features</span><span class="p">(</span><span class="n">history_size</span><span class="p">)</span>
</code></pre>
</div>

<p>Bu özellikler, dediğimiz gibi, önceki K maçın özeti. Bu özetlerin çoğu bir
ortalamadır, ayrıca bu ortalamaların çoğu dakika bazlı çünkü maç zamanını
aşan maçları da hesaba katmak için.. Eğer maç başına yapılan pas değeri
alınsaydı, o zaman vakti aşan bir maçta o değer normalden çok daha fazla
olacaktı, bu modeli bozardı.</p>

<p>Modelde kullanılacak özellikler:</p>

<p><code>is_home</code>: Takım evinde mi, deplasmanda mı oynuyor. Futbolda bu
değişkenin çok önemli olduğunu biliyoruz.</p>

<p><code>avg_points</code>: Önceki K maçta kazanılan ortalama puan (galibiyet için
3, eşitlik için 1, kayıp için 0). </p>

<p><code>avg_goals</code>: Önceki K maçta atılan averaj gol.</p>

<p><code>op_average_goals</code>: Rakip tarafından son K maçta atılan averaj gol.</p>

<p><code>pass_70/80</code>: Hücum sahasının 30%-20%'sinde dakika başına verilen
başarılı pas.</p>

<p><code>op_pass70/80</code>: Hücum sahasının 30%-20%'sinde rakip tarafından
verilmiş dakika bazında başarılı paslar.</p>

<p><code>expected_goals</code>: Son K maçtaki gol beklentisi, ki bu beklenti atılan
şut ve ve şutun kaleden uzaklığı baz alınarak hesaplanan bir sayı.</p>

<p><code>passes</code>: Dakika başına atılan paslar.</p>

<p><code>bad_passes</code>: Dakika bazında verilen ama başarılı olmayan paslar.</p>

<p><code>pass_ratio</code>: Başarılı pasların oranı.</p>

<p><code>corners</code>: Dakika bazında atılan kornerler.</p>

<p><code>fouls</code>: Yapılan faul sayısı (dk bazlı)</p>

<p><code>cards</code>: Kırmızı ya da sarı alınan kart ceza sayısı (maç başına).</p>

<p><code>shots</code>: Dakika bazında atılan şut.</p>

<p><code>op_*</code>: Rakipler hakkındaki bazı tarihi istatistikler. Dikkat, bu
`<code>rakip''</code>op<em>team</em>name<code>de gösterilen rakip değil, genel olarak bu
takımın rakiplerinin ona karşı nasıl oynadığını göstermeye çalışan bir
istatistik. Mesela</code>op_corners` bu takımın rakiplerinin dakika başına
kaç korner kazandığını gösteriyor.</p>

<p><code>*_op_ratio</code>: Takimin istatistiklerinin rakiplerine olan orani [?]</p>

<p>Ozellik olmayan kolonlar</p>

<p><code>matchid</code>: Maçın id'si</p>

<p><code>teamid</code>: Takımın id'si</p>

<p><code>op_teamid</code>: Rakip takımın özgün id'si</p>

<p><code>team_name</code>: Takımın ismi</p>

<p><code>op_team_name</code>: Rakip takımın ismi</p>

<p><code>timestamp</code>: Maç ne zaman oynandı</p>

<p><code>competitionid</code>: Genel müsabakayı gösteren kod (dünya kupası, vs).</p>

<p>Hedef kolonlar:</p>

<p>Alttaki kolonlar tahmin edilmeye uğraşılabilecek olan kolonlar. Eğer
bilinen veri üzerinde tahmin yapmak istiyorsak, bu kolonları tahmin öncesi
dışarı atmalıyız, bunu unutmayalım. Birkaç hedef kolon var ama, biz
sadece kazanılan puanı tahmin etmeye uğraşacağız, belki diğer modeller
diğer kolonları tahmin etmeye uğraşırlar, mesela atılan gol sayısı gibi.</p>

<p><code>points</code>: Maçın puan sonucu.</p>

<p><code>goals</code>: <code>teamid</code> deki takımın attığı gol sayısı.</p>

<p><code>op_goals</code>: <code>op_teamid</code> ile gösterilen takımın attığı gol sayısı.</p>

<div class="codehilite">
<pre><span></span><code><span class="n">club_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;competitionid&#39;</span><span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="mi">4</span><span class="p">]</span>
<span class="c1"># Show the features latest game in competition id 4, which is the world cup.</span>
<span class="nb">print</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;competitionid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre>
</div>

<pre><code>matchid                                  731828
teamid                                      366
op_teamid                                   632
competitionid                                 4
seasonid                                   2013
is_home                                       0
team_name                           Netherlands
op_team_name                          Argentina
timestamp            2014-07-09 21:00:00.000000
goals                                         0
op_goals                                      0
points                                        1
avg_points                              2.33333
avg_goals                               1.33333
op_avg_goals                           0.333333
pass_70                                0.472036
pass_80                                0.150698
op_pass_70                              0.26478
op_pass_80                             0.078501
expected_goals                          1.44437
op_expected_goals                      0.411425
passes                                  3.83486
bad_passes                              1.01362
pass_ratio                             0.765595
corners                               0.0709912
fouls                                  0.126237
cards                                         1
shots                                  0.155226
op_passes                               3.38986
op_bad_passes                           1.02455
op_corners                            0.0346796
op_fouls                               0.157066
op_cards                                2.66667
op_shots                              0.0924966
goals_op_ratio                          1.33333
shots_op_ratio                          1.70227
pass_op_ratio                           1.02543
Name: 0, dtype: object
</code></pre>

<p>Maç bazında atılan goller ve maçın sonucunu eksenlere alarak bir tablo
yaratalım (crosstab).</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="nb">print</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span>
    <span class="n">club_data</span><span class="p">[</span><span class="s1">&#39;goals&#39;</span><span class="p">],</span> 
    <span class="n">club_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;points&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;lose&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;tie&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;win&#39;</span><span class="p">}})[</span><span class="s1">&#39;points&#39;</span><span class="p">])</span>
</code></pre>
</div>

<pre><code>points  lose  tie  win
goals                 
0        768  279    0
1        508  416  334
2        134  218  531
3         23   42  325
4          2    6  158
5          0    2   67
6          0    0   13
7          0    0    6
8          0    0    1
</code></pre>

<p>5'den fazla gol atmak tabii ki kazanmayı garantiliyor, hiç atmamak
75\% ihtimalle kaybedilecek demektir (bazen de beraberlik olur
tabii!). Not: Fakat tabloda 4 gol sonrası kazanımlar direk artmıyor,
niye? Çünkü bu maçlar uzatma sonrası atılan penaltılardan geliyor, her
iki takımda bu sırada çok gol atıyor, ve biri mutlaka kaybediyor [1].</p>

<p>Modeli eğitmek</p>

<p>Veri tabanımızdaki klüp verisini kullanarak (yani hiç dünya kupası verisi
kullanmadan) eğiteceğiz. Bu kod  <code>world_cup.py</code> içinde. Sonuç bir
lojistik regresyon modeli olacak, ve sonra test verisi üzerinde tahmin
yapacağız. Regresyonun Rsquared değerini göstereceğiz, ki bu eğitim
verisi üzerinden gösterilebilir. Rsquared modelin veriye ne kadar uyduğunu
gösteren bir rakamdır, ne kadar yüksekse o kadar iyidir.</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">world_cup</span>
<span class="n">reload</span><span class="p">(</span><span class="n">world_cup</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">match_stats</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>

<span class="c1"># Don&#39;t train on games that ended in a draw, since they have less signal.</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">club_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">club_data</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="mi">1</span><span class="p">]</span> 
<span class="c1"># train = club_data</span>

<span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span> <span class="o">=</span> <span class="n">world_cup</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span>
     <span class="n">train</span><span class="p">,</span> <span class="n">match_stats</span><span class="o">.</span><span class="n">get_non_feature_columns</span><span class="p">())</span>
<span class="nb">print</span> <span class="s2">&quot;Rsquared: </span><span class="si">%0.03g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">model</span><span class="o">.</span><span class="n">prsquared</span>
</code></pre>
</div>

<pre><code>Rsquared: 0.149
</code></pre>

<p>Önemli özellikleri seçmek</p>

<p>Lojistik regresyon modelimiz regülarizasyon kullanıyor; bu demektir ki daha
çetrefil modeller cezalandırılıyor. Bu cezalandırmanın yan etkisi olarak
biz hangi özelliklerin daha önemli olduğunu görebiliyoruz, çünkü daha
önemsiz olan özellikler modelden atılıyorlar (katsayıları sıfıra iniyor). </p>

<p>Bu bağlamda özellikleri üçe ayırabiliriz:</p>

<p>Pozitif özellikler: Bu özellikler mevcut ise takımın kazanma şansı yükseliyor.</p>

<p>Negative özellikler: Tam tersi</p>

<p>Atılan değerler: Önemli olmayan özellikler, ki bu özellikler modele dahil
edilirse aşırı uygunluk (overfitting) durumu ortaya çıkar. </p>

<div class="codehilite">
<pre><span></span><code><span class="k">def</span> <span class="nf">print_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>    
    <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">params</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">limit</span><span class="p">:</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pozitif ozellikler&quot;</span><span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">params</span><span class="p">[[</span><span class="n">param</span> <span class="o">&gt;</span> <span class="mf">0.001</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]])</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)[:</span><span class="n">limit</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Atilan ozellikler&quot;</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">params</span><span class="p">[[</span><span class="n">param</span>  <span class="o">==</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]][:</span><span class="n">limit</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Negatif ozellikler&quot;</span><span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">params</span><span class="p">[[</span><span class="n">param</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.001</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]])</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)[:</span><span class="n">limit</span><span class="p">]</span>

<span class="n">print_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</code></pre>
</div>

<pre><code>Pozitif ozellikler
is_home           0.848337
pass_70           0.254729
expected_goals    0.169235
opp_op_corners    0.159163
op_passes         0.120319
opp_op_pass_80    0.095970
avg_goals         0.092000
opp_bad_passes    0.075657
opp_cards         0.068903
fouls             0.062809
dtype: float64

Atilan ozellikler
op_pass_70            0
opp_op_cards          0
op_bad_passes         0
opp_op_bad_passes     0
opp_op_fouls          0
corners               0
pass_ratio            0
opp_corners           0
op_fouls              0
opp_goals_op_ratio    0
dtype: float64

Negatif ozellikler
opp_pass_70          -0.203015
opp_expected_goals   -0.144740
op_corners           -0.137309
opp_op_passes        -0.107397
op_pass_80           -0.087566
opp_avg_goals        -0.084249
bad_passes           -0.070335
cards                -0.064461
opp_fouls            -0.059097
opp_passes           -0.049240
dtype: float64
</code></pre>

<p>Klüp verisi üzerinde tahmin</p>

<p><code>predicted</code>: Takımın kazanma şansı (tahmin).</p>

<p><code>points</code>: Gerçekten ne oldu.</p>

<div class="codehilite">
<pre><span></span><code><span class="n">reload</span><span class="p">(</span><span class="n">world_cup</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">world_cup</span><span class="o">.</span><span class="n">predict_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">match_stats</span><span class="o">.</span><span class="n">get_non_feature_columns</span><span class="p">())</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="n">world_cup</span><span class="o">.</span><span class="n">extract_predictions</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;predicted&#39;</span><span class="p">])</span>

<span class="nb">print</span> <span class="s1">&#39;Dogru tahminler:&#39;</span>
<span class="nb">print</span> <span class="n">predictions</span><span class="p">[(</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;predicted&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)][:</span><span class="mi">5</span><span class="p">]</span>
</code></pre>
</div>

<pre><code>Dogru tahminler:
             team_name         op_team_name  predicted            expected  \
8     Portland Timbers       Real Salt Lake  52.418756    Portland Timbers   
42      Rayo Vallecano           Granada CF  60.862465      Rayo Vallecano   
49  Atltico de Madrid               Getafe  64.383541  Atltico de Madrid   
57     Colorado Rapids  Vancouver Whitecaps  51.836366     Colorado Rapids   
58         Real Madrid        Real Sociedad  64.100904         Real Madrid   

                winner  points  
8     Portland Timbers       3  
42      Rayo Vallecano       3  
49  Atltico de Madrid       3  
57     Colorado Rapids       3  
58         Real Madrid       3  
</code></pre>

<div class="codehilite">
<pre><span></span><code><span class="nb">print</span> <span class="s1">&#39;Yanlis tahminler:&#39;</span>
<span class="nb">print</span> <span class="n">predictions</span><span class="p">[(</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;predicted&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)][:</span><span class="mi">5</span><span class="p">]</span>
</code></pre>
</div>

<pre><code>Yanlis tahminler:
                 team_name         op_team_name  predicted  \
1      Seattle Sounders FC  Vancouver Whitecaps  51.544963   
2   New England Revolution       Real Salt Lake  63.950714   
3       Philadelphia Union            FC Dallas  54.213693   
14  New England Revolution      Montreal Impact  52.762065   
20      New York Red Bulls           Toronto FC  55.533969   

                  expected               winner  points  
1      Seattle Sounders FC  Vancouver Whitecaps       0  
2   New England Revolution       Real Salt Lake       0  
3       Philadelphia Union            FC Dallas       0  
14  New England Revolution      Montreal Impact       0  
20      New York Red Bulls           Toronto FC       0  
</code></pre>

<p>Tahminlerimizi kontrol etmek</p>

<p>Kontrol için mesela hesabımızın rasgele tahminden ne kadar iyi olduğunu
hesaplayabiliriz (lift) ya da AUC hesabı yapıp ROC eğrisini hesaplarız. AUC
herhalde en iyisi, bu hesap çok ilginçtir, 0.5 (kafadan atmak) ve 1.0
arasındadır (mükemmel tahmin), ve bu hesap dengesiz veri setlerine karşı
dayanıklıdır. Mesela 0/1 etiketi tahmininde test setinde diyelim ki yüzde 90
oranında olsa ve modelimiz sürekli 1 tahmin etse, basit bir ölçüm bize
modelimizin yüzde 90 başarılı olduğunu söylerdi. AUC böyle durumlara karşı
dayanıklıdır, bize 0.5 sonucunu verir. </p>

<div class="codehilite">
<pre><span></span><code><span class="n">baseline</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">yval</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">yval</span> <span class="ow">in</span> <span class="n">club_data</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]])</span> 
            <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">club_data</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">yval</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">yval</span> <span class="ow">in</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]]</span>
<span class="n">world_cup</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;predicted&#39;</span><span class="p">],</span> <span class="n">baseline</span><span class="p">,</span> 
                   <span class="n">compute_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;stat_worldcup_01.png&#39;</span><span class="p">)</span>
</code></pre>
</div>

<pre><code>(3) Lift: 1.42 Auc: 0.738
</code></pre>

<p><img src="stat_worldcup_01.png" alt="" /></p>

<p>Modelde eksik olan bir şey var; sonraki maçı önceki birkaç maçın özetinden
tahmin etmeye uğraşıyoruz ama belki bazı takımlar önceki K maçta çok zorlu
rakiplerle uğraşmıştır, bazıları çok kolay rakiplerle uğraşmıştır. Bu
durumda önceki maçların istatistiği bize tüm hikayeyi anlatmayacaktır. </p>

<p>Bu problemi çözmek için ayrı bir regresyon daha işletebiliriz. Bu regresyon
bir güç sıralaması (power ranking) hesaplayabilir, bu hesap
FIFA/CocaCola'nın enternasyonel takımlar için yaptığı 
güç sıralama hesabına benzer. ABD'de beyzbol ve Amerikan futbolu için de
benzer bir hesap yapılıyor. </p>

<p>Güç sıralaması hesabını yaptıktan sonra -tek bir sayı, bazı takımlar için daha
yüksek bazı takımlar için daha alçak, ki onun üzerinden sıralama yapılabilsin-
onu bir özellik olarak lojistik regresyon modeline dahil edebiliriz. Güç
sıralaması esas olarak şu tür irdelemelerin modelimize dahilini mümkün kılar; A
takımı B'yi yendiyse, B C'yi yendiyse, A büyük ihtimalle C'yi yener. Bu tür
bilgi niye önemli?  Çünkü elimizde yapılabilecek tüm maçların kombinasyonu yok,
maç verisi seyrek (sparse). Ama eldeki birkaç maçtan bir güç sıralaması
hesaplayabilirsek, bu bize takımlar arasında, daha önce maç oynamamış olsalar
bile, otomatik olarak bir ek irdeleme yapabilmemizi sağlayacaktır.</p>

<p>Sıralama hesabı yapıldıktan sonra bazı kontrolleri hızla, çıplak gözle
yapabiliriz, mesela sonuca bakarız, eğer Wiggan (zayıf bir takım) 1.0
değeri almış, Chelsea (güçlü bir takım) 0.0 değeri almış ise bir şeyler
yanlış demektir.</p>

<p>Tabii buna rağmen bazı takımlara hala uygun sıralama veremeyebiliriz,
mesela A,B'yi, B,C'yi yeniyor, sonra veriye göre, C A'yı yeniyor. Bu
şekilde sıralayamadığımız durumda takıma 0.5 verip tam ortaya koyacağız.</p>

<p>Ayrıca enternasyonel takımların sıralaması çok gürültülü veri olduğu ve
(klüp verisinden bile daha) seyrek olduğu için onu yüzdeliklere (quartiles)
ayırarak göstereceğiz, yani sıralamalar 0, .33, .66, or 1.0 olarak
gözükecekler.</p>

<p>Fakat hesap işi bitince, ve bu sıralamayı nihai lojistik modele dahil
edince başarı oranımızın zıplama yaptığını göreceğiz.</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">power</span>
<span class="n">reload</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>
<span class="n">reload</span><span class="p">(</span><span class="n">world_cup</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">points_to_sgn</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1.0</span>
  <span class="k">elif</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">:</span> <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span>
  <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mf">0.0</span>
<span class="n">power_cols</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">(</span><span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="n">points_to_sgn</span><span class="p">,</span> <span class="s1">&#39;points&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">power_data</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">add_power</span><span class="p">(</span><span class="n">club_data</span><span class="p">,</span> <span class="n">game_summaries</span><span class="p">,</span> <span class="n">power_cols</span><span class="p">)</span>
<span class="n">power_train</span> <span class="o">=</span> <span class="n">power_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">power_data</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]</span> <span class="o">&lt;&gt;</span> <span class="mi">1</span><span class="p">]</span> 

<span class="c1"># power_train = power_data</span>
<span class="p">(</span><span class="n">power_model</span><span class="p">,</span> <span class="n">power_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">world_cup</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span>
    <span class="n">power_train</span><span class="p">,</span> <span class="n">match_stats</span><span class="o">.</span><span class="n">get_non_feature_columns</span><span class="p">())</span>
<span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Rsquared: </span><span class="si">%0.03g</span><span class="s2">, Power Coef </span><span class="si">%0.03g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="n">power_model</span><span class="o">.</span><span class="n">prsquared</span><span class="p">,</span> 
    <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">power_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;power_points&#39;</span><span class="p">]))</span>

<span class="n">power_results</span> <span class="o">=</span> <span class="n">world_cup</span><span class="o">.</span><span class="n">predict_model</span><span class="p">(</span><span class="n">power_model</span><span class="p">,</span> <span class="n">power_test</span><span class="p">,</span> 
    <span class="n">match_stats</span><span class="o">.</span><span class="n">get_non_feature_columns</span><span class="p">())</span>
<span class="n">power_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">yval</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">yval</span> <span class="ow">in</span> <span class="n">power_test</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]]</span>
<span class="n">world_cup</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">power_y</span><span class="p">,</span> <span class="n">power_results</span><span class="p">[</span><span class="s1">&#39;predicted&#39;</span><span class="p">],</span> <span class="n">baseline</span><span class="p">,</span> 
                   <span class="n">compute_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">print_params</span><span class="p">(</span><span class="n">power_model</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Luck&#39;</span><span class="p">)</span>
<span class="c1"># Add the old model to the graph</span>
<span class="n">world_cup</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="s1">&#39;old&#39;</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;predicted&#39;</span><span class="p">],</span> <span class="n">baseline</span><span class="p">,</span> 
                   <span class="n">compute_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;world_cup_02.png&#39;</span><span class="p">)</span>
</code></pre>
</div>

<pre><code>New season 2014
New season 2013
New season 2013
New season 2012
New season 2012
New season 2011

['Blackburn Rovers: 0.000', 'Real Betis: 0.000', 'D.C. United: 0.000',
'Celta de Vigo: 0.004', 'Deportivo de La Coru\xc3\xb1a: 0.009',
'Wolverhampton Wanderers: 0.021', 'Reading: 0.022', 'Real Zaragoza: 0.026',
'Real Valladolid: 0.044', 'Granada CF: 0.062', 'Queens Park Rangers:
0.073', 'Mallorca: 0.089', 'Aston Villa: 0.092', 'Bolton Wanderers: 0.102',
'Osasuna: 0.109', 'Espanyol: 0.112', 'Wigan Athletic: 0.124', 'Sunderland:
0.130', 'Rayo Vallecano: 0.138', 'Almer\xc3\xada: 0.145', 'Levante: 0.148',
'Elche: 0.154', 'Getafe: 0.170', 'Swansea City: 0.192', 'Southampton:
0.197', 'Norwich City: 0.206', 'Toronto FC: 0.211', 'Chivas USA: 0.218',
'West Ham United: 0.220', 'West Bromwich Albion: 0.224', 'Villarreal:
0.231', 'Stoke City: 0.255', 'Fulham: 0.274', 'Valencia: 0.296', 'Valencia
CF: 0.296', 'M\xc3\xa1laga: 0.305', 'Newcastle United: 0.342', 'Sevilla:
0.365', 'Columbus Crew: 0.366', 'Athletic Club: 0.386', 'Liverpool: 0.397',
'Everton: 0.417', 'Philadelphia Union: 0.466', 'Montreal Impact: 0.470',
'Chelsea: 0.530', 'Real Sociedad: 0.535', 'Tottenham Hotspur: 0.551',
'Arsenal: 0.592', 'Houston Dynamo: 0.593', 'FC Dallas: 0.612', 'Chicago
Fire: 0.612', 'Vancouver Whitecaps: 0.615', 'San Jose Earthquakes: 0.632',
'New England Revolution: 0.634', 'Atl\xc3\xa9tico de Madrid: 0.672',
'Colorado Rapids: 0.743', 'Barcelona: 0.759', 'Seattle Sounders FC: 0.781',
'New York Red Bulls: 0.814', 'Sporting Kansas City: 0.854', 'LA Galaxy:
0.882', 'Real Salt Lake: 0.922', 'Manchester City: 0.928', 'Real Madrid:
1.000', 'Manchester United: 1.000', 'Portland Timbers: 1.000'] 

Rsquared: 0.22, Power Coef 2.18
(3) Lift: 1.56 Auc: 0.791
    Base: 0.374 Acc: 0.708 P(1|t): 0.778 P(0|f): 0.667
    Fp/Fn/Tp/Tn p/n/c: 99/248/347/496 595/595/1190
Pozitif ozellikler
power_points      1.177169
is_home           0.787110
opp_op_corners    0.170848
expected_goals    0.058597
opp_cards         0.045538
pass_70           0.036267
avg_goals         0.035456
opp_avg_points    0.033857
dtype: float64

Atilan ozellikler
passes                0
op_pass_80            0
op_expected_goals     0
opp_shots_op_ratio    0
bad_passes            0
pass_ratio            0
opp_pass_op_ratio     0
shots                 0
dtype: float64

Negatif ozellikler
opp_power_points     -0.540688
op_corners           -0.145918
opp_expected_goals   -0.055353
cards                -0.043555
opp_pass_70          -0.034997
opp_avg_goals        -0.034242
avg_points           -0.032748
opp_fouls            -0.022867
dtype: float64
(old) Lift: 1.42 Auc: 0.738
</code></pre>

<p><img src="stat_worldcup_02.png" alt="" /></p>

<p>Şimdi dünya kupasını tahmin edelim!</p>

<p>Aynen klüp verisinde yaptığımız gibi dünya kupası için de benzer
istatistikleri hesaplayabiliriz. Bu durumda elimizde hedefler olmayacak,
yani kimin kazandığını bilemeyeceğiz (aslında bazı dünya kupası maçlarının
sonucunu biliyoruz, ama tahminlerimizi hiçbir maçı bilmiyormuş gibi
yapalım). Ve tekrar vurgulayalım: klüp verisiyle eğittiğimiz modeli
kullanarak dünya kupasını tahmin edeceğiz. Yani model ve tahmin tamamen
farklı takımlar üzerinden yapılacak!</p>

<p><code>features.get_wc_features()</code> bize tüm dünya kupası maçları için
gereken özellikleri yaratıp döndürecektir.</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">world_cup</span>
<span class="kn">import</span> <span class="nn">features</span>
<span class="n">reload</span><span class="p">(</span><span class="n">match_stats</span><span class="p">)</span>
<span class="n">reload</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<span class="n">reload</span><span class="p">(</span><span class="n">world_cup</span><span class="p">)</span>
<span class="n">wc_data</span> <span class="o">=</span> <span class="n">world_cup</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">get_wc_features</span><span class="p">(</span><span class="n">history_size</span><span class="p">))</span>
<span class="n">wc_labeled</span> <span class="o">=</span> <span class="n">world_cup</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">get_features</span><span class="p">(</span><span class="n">history_size</span><span class="p">))</span>
<span class="n">wc_labeled</span> <span class="o">=</span> <span class="n">wc_labeled</span><span class="p">[</span><span class="n">wc_labeled</span><span class="p">[</span><span class="s1">&#39;competitionid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">]</span>
<span class="n">wc_power_train</span> <span class="o">=</span> <span class="n">game_summaries</span><span class="p">[</span><span class="n">game_summaries</span><span class="p">[</span><span class="s1">&#39;competitionid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre>
</div>

<p>Ev sahası avantajı</p>

<p>Klüp verisi ile dünya kupası verisi arasındaki bazı farklardan biri budur:
dünya kupasında bir maçta ev sahibi olmak ya da deplasmanda olmak ne
demektir?  Resmi olarak tek ev sahibi tüm 2014 kupasına ev sahipliği yapan
Brezilya'dır, o zaman sadece Brezilya mı oynadığı maçlarda ev sahibi
olabilir? Bu pek akla yatkın gelmiyor.</p>

<p>Belki diğer Latin Amerika takımlarını da ev sahibi olarak
görebiliriz.. Adam aynı kıtadan, belki o kıtaya alışık, iklimi vs ona
normal geliyor.. ? Olabilir mi? Diğer bazı modeller <code>is_home</code> u sadece
Brezilya'ya vermiş, sonra aynı kitadaki diğer takımlara da 'azıcık' ev
sahipliği vermişler, çünkü istatistiklere göre bu takımlar kendi
kıtalarında daha iyi performans gösteriyorlarmış, vs.</p>

<p>Biz daha değişik bir model kullanacağız, bu model belki biraz
sübjektif.. Biz <code>is_home</code> öğesine 0.0 ila 1.0 arasında bir değer
atayacağız, ve bu değerin büyüklüğü o takımın taraftarlarının hem sayı, hem
de destek enerjisi üzerinden ölçülecek. Bunu yapmamızın sebebi ilk turlarda
görüldüğü üzere, taraftarının daha iyi desteklediği takımların diğerlerine
göre daha iyi performans göstermesi. Mesela Şili'nin taraftarı takımını
müthiş destekledi, İspanya taraftarı oralı bile olmadı, Şili-İspanya maçını
Şili 2-0 kazandı. Bunun gibi pek çok maç gözlemledik, çoğunda güney Amerika
takımları vardı, ama çok taraftar gönderen takımlar da vardı, mesela
Meksika. Ya da ABD vardı, çok taraftarı vardı ama sessizdiler, onlar daha
düşük skorlar aldılar.</p>

<pre><code>import pandas as pd
wc_home = pd.read_csv('wc_home.csv')

def add_home_override(df, home_map):
  for ii in xrange(len(df)):
    team = df.iloc[ii]['teamid']
    if team in home_map:
        df['is_home'].iloc[ii] = home_map[team]
    else:
        # If we don't know, assume not at home.
        df['is_home'].iloc[ii] = 0.0

home_override = {}
for ii in xrange(len(wc_home)):
    row = wc_home.iloc[ii]
    home_override[row['teamid']] = row['is_home']

# Add home team overrides.
add_home_override(wc_data, home_override)    
</code></pre>

<p>Dünya Kupası Güç Sıralaması</p>

<p>Bu hesabın dünya kupası verisi üzerinde yapılması lazım, çünkü güç
sıralaması o takımların arasındaki maçlara dayanılarak yapılan bir
hesap. Bu maçlar ise, dünya kupası takımları bağlamında, oldukça seyrek
çünkü bazı takımlar bazı takımlarla neredeyse onyıldır oynamamış. Çoğu
Avrupa takımı mesela güney Amerika takımıyla oynamamış, Asyalı takımlarla
daha bile az oynamış. Klüp bazında kullandığımız aynı numarayı burada da
kullanabiliriz, ama başarısızlığa hazır olmak lazım! </p>

<p>Hesap altta</p>

<div class="codehilite">
<pre><span></span><code><span class="c1"># Guc verisiyle egitirken, kupa birden fazla maca yayildigi icin </span>
<span class="c1"># is_home&#39;u 0.5&#39;e set et. Yoksa 2010&#39;daki kupa maclarina baktigimizda</span>
<span class="c1"># Guney Afrika yerine Brezilya&#39;nin hala ev sahibi olduugnu zannedebilirdik.</span>

<span class="n">wc_power_train</span><span class="p">[</span><span class="s1">&#39;is_home&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">wc_power_data</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">add_power</span><span class="p">(</span><span class="n">wc_data</span><span class="p">,</span> <span class="n">wc_power_train</span><span class="p">,</span> <span class="n">power_cols</span><span class="p">)</span>

<span class="n">wc_results</span> <span class="o">=</span> <span class="n">world_cup</span><span class="o">.</span><span class="n">predict_model</span><span class="p">(</span><span class="n">power_model</span><span class="p">,</span> <span class="n">wc_power_data</span><span class="p">,</span> 
    <span class="n">match_stats</span><span class="o">.</span><span class="n">get_non_feature_columns</span><span class="p">())</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">New</span> <span class="n">season</span> <span class="mi">2013</span>
<span class="n">New</span> <span class="n">season</span> <span class="mi">2009</span>
<span class="n">New</span> <span class="n">season</span> <span class="mi">6</span>
<span class="p">[</span><span class="s1">&#39;Australia: 0.000&#39;</span><span class="p">,</span> <span class="s1">&#39;Serbia: 0.016&#39;</span><span class="p">,</span> <span class="s1">&#39;USA: 0.017&#39;</span><span class="p">,</span> <span class="s1">&#39;Cameroon: 0.035&#39;</span><span class="p">,</span>
<span class="s1">&#39;Iran: 0.081&#39;</span><span class="p">,</span> <span class="s1">&#39;Croatia: 0.180&#39;</span><span class="p">,</span> <span class="s1">&#39;Nigeria: 0.204&#39;</span><span class="p">,</span> <span class="s2">&quot;C</span><span class="se">\xc3\xb4</span><span class="s2">te d&#39;Ivoire:</span>
<span class="mf">0.244</span><span class="s2">&quot;, &#39;Costa Rica: 0.254&#39;, &#39;Algeria: 0.267&#39;, &#39;Paraguay: 0.277&#39;,</span>
<span class="s1">&#39;Honduras: 0.279&#39;</span><span class="p">,</span> <span class="s1">&#39;Slovakia: 0.281&#39;</span><span class="p">,</span> <span class="s1">&#39;Greece: 0.284&#39;</span><span class="p">,</span> <span class="s1">&#39;Switzerland:</span>
<span class="mf">0.291</span><span class="s1">&#39;, &#39;</span><span class="n">Ecuador</span><span class="p">:</span> <span class="mf">0.342</span><span class="s1">&#39;, &#39;</span><span class="n">Uruguay</span><span class="p">:</span> <span class="mf">0.367</span><span class="s1">&#39;, &#39;</span><span class="n">Sweden</span><span class="p">:</span> <span class="mf">0.386</span><span class="s1">&#39;, &#39;</span><span class="n">Japan</span><span class="p">:</span>
<span class="mf">0.406</span><span class="s1">&#39;, &#39;</span><span class="n">Mexico</span><span class="p">:</span> <span class="mf">0.409</span><span class="s1">&#39;, &#39;</span><span class="n">Chile</span><span class="p">:</span> <span class="mf">0.413</span><span class="s1">&#39;, &#39;</span><span class="n">Colombia</span><span class="p">:</span> <span class="mf">0.438</span><span class="s1">&#39;, &#39;</span><span class="n">England</span><span class="p">:</span>
<span class="mf">0.460</span><span class="s1">&#39;, &#39;</span><span class="n">Belgium</span><span class="p">:</span> <span class="mf">0.467</span><span class="s1">&#39;, &#39;</span><span class="n">Ukraine</span><span class="p">:</span> <span class="mf">0.470</span><span class="s1">&#39;, &#39;</span><span class="n">Portugal</span><span class="p">:</span> <span class="mf">0.487</span><span class="s1">&#39;, &#39;</span><span class="n">Ghana</span><span class="p">:</span>
<span class="mf">0.519</span><span class="s1">&#39;, &#39;</span><span class="n">South</span> <span class="n">Korea</span><span class="p">:</span> <span class="mf">0.532</span><span class="s1">&#39;, &#39;</span><span class="n">France</span><span class="p">:</span> <span class="mf">0.648</span><span class="s1">&#39;, &#39;</span><span class="n">Spain</span><span class="p">:</span> <span class="mf">0.736</span><span class="s1">&#39;, &#39;</span><span class="n">Argentina</span><span class="p">:</span>
<span class="mf">0.793</span><span class="s1">&#39;, &#39;</span><span class="n">Italy</span><span class="p">:</span> <span class="mf">0.798</span><span class="s1">&#39;, &#39;</span><span class="n">Brazil</span><span class="p">:</span> <span class="mf">0.898</span><span class="s1">&#39;, &#39;</span><span class="n">Netherlands</span><span class="p">:</span> <span class="mf">0.918</span><span class="s1">&#39;, &#39;</span><span class="n">Germany</span><span class="p">:</span>
<span class="mf">1.000</span><span class="s1">&#39;] </span>
</code></pre>
</div>

<p>Güç sırası da ayrı bir lojistik regresyon aslında, <code>power.py</code> içinde
biz bu regresyona giren matris ve etiketleri hesap yapılmadan önce çekip
çıkarttık, ve bir dosyaya kaydettirdik. Bakarsak,</p>

<div class="codehilite">
<pre><span></span><code><span class="n">games</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/tmp/games.csv&#39;</span><span class="p">)</span>
<span class="n">outcomes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/tmp/outcomes.csv&#39;</span><span class="p">)</span>
</code></pre>
</div>

<p>Herhangi bir satıra göz atalım,</p>

<div class="codehilite">
<pre><span></span><code><span class="nb">print</span> <span class="s1">&#39;mac&#39;</span><span class="p">,</span> <span class="n">games</span><span class="p">[</span><span class="mi">100</span><span class="p">:</span><span class="mi">101</span><span class="p">]</span>
<span class="nb">print</span> <span class="s1">&#39;sonuc&#39;</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">[</span><span class="mi">100</span><span class="p">:</span><span class="mi">101</span><span class="p">]</span>
</code></pre>
</div>

<pre><code>mac      1041  1042  114  1161  118  119  1215  1216  1219  1221  1223  1224  \
100     0     0    0     0    0    0     0     0     0     0     0     0   

     1264  1266  1794  1801  1804  357  359  360  361  364  365  366  367  \
100     0     0     0     0     0    0    0    0    0    0    0    0    0   

     368     369     494  497  507  510  511  517  522  535  536  537  575  \
100    0 -1.5625  1.5625    0    0    0    0    0    0    0    0    0    0   

     596  614  632  659  830  831  832  835  837  838  847  
100    0    0    0    0    0    0    0    0    0    0    0  
sonuc      0.0
100    0
</code></pre>

<p>Yani güç sıralaması lojistik regresyonuna girdi olan matrisin her satırı
ayrı bir maç, her kolonu ise ayrı bir takım. Maç yapan iki takımın
değerleri olacak, diğerleri sıfır olacak. Üstteki satır mesela, 369. takım
ve rakipte 494. takım için,</p>

<div class="codehilite">
<pre><span></span><code><span class="n">raw_games</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;results-20140714-124014.csv&#39;</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">raw_games</span><span class="p">[(</span><span class="n">raw_games</span><span class="p">[</span><span class="s1">&#39;teamid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">369</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">raw_games</span><span class="p">[</span><span class="s1">&#39;op_teamid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">494</span><span class="p">)]</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[[</span><span class="s1">&#39;teamid&#39;</span><span class="p">,</span><span class="s1">&#39;team_name&#39;</span><span class="p">,</span><span class="s1">&#39;op_team_name&#39;</span><span class="p">,</span><span class="s1">&#39;is_home&#39;</span><span class="p">,</span><span class="s1">&#39;points&#39;</span><span class="p">]]</span>
<span class="nb">print</span> <span class="n">tmp</span>
</code></pre>
</div>

<pre><code>      teamid team_name op_team_name  is_home  points
4231     369   Denmark     Cameroon        0       3
</code></pre>

<p>Danimarka Kamerun maçına aitmiş. Bu maçta Danimarka kazandı, ev sahibi
Kamerun. Şimdi burada birkaç önemli takla atılıyor, Google veri bilimcileri
lojistik regresyonda, girdi olarak, deplasman takımına her maç başında
otomatik olarak eksi bir değer veriyorlar, ev sahibine artı değer
veriyorlar. Etiket ise 'ev sahibi kazandı mı?' sorusunun cevabı.</p>

<p>Ev sahibi olup kazanmak daha kolay, regresyon bağlamında artı değere sahip
olursanız, az bir katsayı modeli uydurmaya yeterli olabilir, pozitife hemen
yaklaşırız. Diğer yandan deplasman takımı ne kadar iyi oynarsa, onun büyüyen
katsayısı eksi değerini o kadar arttırır, ve ev sahibinin artışını (onun
öğesi çarpı katsayısı yani) eksilterek kaybetme durumuna yaklaştırır.</p>

<p>Kötü oynayan deplasman takımının eksi değeri eksi katsayı ile çarpılır, ve daha
büyük bir artı sayıyı oluşturur, ev sahibinin kazanması durumunu güçlendirir.</p>

<p>Katsayıları doğal olarak bir takımın ne kadar iyi olduğunu gösterecektir. </p>

<p>Tabii regresyona pek çok satır verilecek, Kamerun birden fazla satırda
ortaya çıkabilecek (ama hep aynı kolonda, işin püf noktası burada), bazen
artı değerli olarak (ev sahibi) bazen eksi değerli olarak (deplasman).</p>

<p>İtiraf etmek gerekir ki veri bilimi bağlamında üstteki teknik, model,
düşünce tarzı dahiyane bir yaklaşım, alanın ruhunu göstermesi bakımından
eğitici. Veri temsilinden tutun, regresyonun kodlanmasında çeyrekliklere
ayırmak, az veri olduğu için yaklaşıksallık (convergence) olmayabilir diye
değişik parametrelerle regresyonu birkaç kez işletmek, bunu yaklaşıksallık
olana kadar yapmak, tam anlamıyla bir ders niteliği taşıyor.</p>

<p>Tahmin</p>

<p>Nihayet hazırlandığımız ana geldik. Şimdi dünya kupası maçlarını tahmin
edelim. Birkaç kolon göstereceğiz:</p>

<p><code>predicted</code>: Yüzde kaç ihtimalle (ismi ilk gelen) takımın kazanacağı</p>

<p><code>points</code>: Gerçekten ne olduğu. Oynanmayan maç <code>NaN</code>. Dikkat,
penaltı atışlarına giden maçlar eşitlik olarak gösterilecek.</p>

<p>Ama bir dakika! Bu sonuçlar daha önce gösterdiğiniz [Google tahminleri
kastediliyor] tahminlerinden değişik! Bunun sebepleri şunlar: Bazı hataları
tamir ettik, yani kod değişti. İlk model mesela uzayan maçlar yüzünden
kabaran istatistiklerin durumunu hesaba almıyordu.</p>

<p>İkinci sebep, model baştan planlı (deterministik) değil, eğitim verisi için
verinin belli bir kısmını rasgele olarak seçiyoruz, bu sebeple sonuçlar bir
hesaptan diğerine değişik çıkabiliyor (ki bazen sonuçlar çok değişik
olabiliyor). Not: Aslında bu kod değiştirilerek rasgelelik içinden tamamen
çıkartılabilir (ev ödeviniz!).</p>

<p>16'ıncı turu tahmin ederken mesela önceki 3 maçı, çeyrek finaller için
önceki 4, yarıfınaller için 5, ve finaller için önceki 6 maçı
kullandık [biz bu dokümanda önceki 3 maçı kullandık, <code>history_size</code>
parametresiyle oynayarak değişik sonuçlar kontrol edilebilir].</p>

<div class="codehilite">
<pre><span></span><code><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">wc_with_points</span> <span class="o">=</span> <span class="n">wc_power_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">wc_with_points</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span>
    <span class="nb">zip</span><span class="p">(</span><span class="n">wc_with_points</span><span class="p">[</span><span class="s1">&#39;matchid&#39;</span><span class="p">],</span> <span class="n">wc_with_points</span><span class="p">[</span><span class="s1">&#39;teamid&#39;</span><span class="p">]))</span>
<span class="n">wc_labeled</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span>
    <span class="nb">zip</span><span class="p">(</span><span class="n">wc_labeled</span><span class="p">[</span><span class="s1">&#39;matchid&#39;</span><span class="p">],</span> <span class="n">wc_labeled</span><span class="p">[</span><span class="s1">&#39;teamid&#39;</span><span class="p">]))</span>
<span class="n">wc_with_points</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wc_labeled</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]</span>

<span class="n">wc_pred</span> <span class="o">=</span> <span class="n">world_cup</span><span class="o">.</span><span class="n">extract_predictions</span><span class="p">(</span><span class="n">wc_with_points</span><span class="p">,</span> 
                                        <span class="n">wc_results</span><span class="p">[</span><span class="s1">&#39;predicted&#39;</span><span class="p">])</span>

<span class="c1"># Reverse our predictions to show the most recent first.</span>
<span class="n">wc_pred</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">wc_pred</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># Show our predictions for the games that have already happenned.</span>
<span class="nb">print</span> <span class="n">wc_pred</span>
</code></pre>
</div>

<pre><code>        team_name   op_team_name  predicted       expected         winner  points
0       Argentina        Germany  46.070814        Germany             NA     NaN
1     Netherlands         Brazil  42.833863         Brazil             NA     NaN
2     Netherlands      Argentina  48.641542      Argentina           draw       1
3         Germany         Brazil  44.011593         Brazil        Germany       3
4      Costa Rica    Netherlands  14.442625    Netherlands           draw       1
5         Belgium      Argentina  18.596031      Argentina      Argentina       0
6        Colombia         Brazil  23.890421         Brazil         Brazil       0
7         Germany         France  75.116349        Germany        Germany       3
8             USA        Belgium  32.400646        Belgium        Belgium       0
9     Switzerland      Argentina  19.272768      Argentina      Argentina       0
10        Algeria        Germany   5.926496        Germany        Germany       0
11        Nigeria         France   8.694729         France         France       0
12         Greece     Costa Rica  40.448104     Costa Rica           draw       1
13         Mexico    Netherlands  20.402491    Netherlands    Netherlands       0
14        Uruguay       Colombia  46.480264       Colombia       Colombia       0
15          Chile         Brazil  26.574916         Brazil           draw       1
16        Germany            USA  91.980986        Germany        Germany       3
17          Ghana       Portugal  49.051707       Portugal       Portugal       0
18    Switzerland       Honduras  60.223070    Switzerland    Switzerland       3
19         France        Ecuador  84.538857         France           draw       1
20      Argentina        Nigeria  88.491450      Argentina      Argentina       3
21  CÃ´te d'Ivoire         Greece  61.074502  CÃ´te d'Ivoire         Greece       0
22        Uruguay          Italy  32.685428          Italy        Uruguay       3
23        England     Costa Rica  63.457326        England           draw       1
24         Brazil       Cameroon  94.788074         Brazil         Brazil       3
25         Mexico        Croatia  78.020214         Mexico         Mexico       3
26          Spain      Australia  90.521542          Spain          Spain       3
27          Chile    Netherlands  28.342133    Netherlands    Netherlands       0
28       Portugal            USA  65.457259       Portugal           draw       1
29        Algeria    South Korea  17.376285    South Korea        Algeria       3
30          Ghana        Germany  14.588539        Germany           draw       1
31           Iran      Argentina   5.193843      Argentina      Argentina       0
32        Ecuador       Honduras  53.848926        Ecuador        Ecuador       3
33         France    Switzerland  78.659381         France         France       3
34     Costa Rica          Italy  24.836756          Italy     Costa Rica       3
35         Greece          Japan  44.355013          Japan           draw       1
36        England        Uruguay  61.012694        England        Uruguay       0
37        Croatia       Cameroon  40.212875       Cameroon        Croatia       3
38          Chile          Spain  42.624474          Spain          Chile       3
39    Netherlands      Australia  93.535889    Netherlands    Netherlands       3
40         Mexico         Brazil  20.372064         Brazil           draw       1
41            USA          Ghana  39.500993          Ghana            USA       3
42        Nigeria           Iran  53.813244        Nigeria           draw       1
43       Portugal        Germany  15.337884        Germany        Germany       0
44       Honduras         France  22.953848         France         France       0
45        Ecuador    Switzerland  59.987076        Ecuador    Switzerland       0
46          Japan  CÃ´te d'Ivoire  51.528885          Japan  CÃ´te d'Ivoire       0
47          Italy        England  68.767968          Italy          Italy       3
48     Costa Rica        Uruguay  45.347946        Uruguay     Costa Rica       3
49      Australia          Chile  19.487987          Chile          Chile       0
50    Netherlands          Spain  60.493928    Netherlands    Netherlands       3
51       Cameroon         Mexico  30.018950         Mexico         Mexico       0
52        Croatia         Brazil   6.268704         Brazil         Brazil       0
53          Spain    Netherlands  35.602227    Netherlands          Spain       3
54        Germany        Uruguay  76.467450        Germany        Germany       3
55          Spain        Germany  29.438134        Germany          Spain       3
56    Netherlands        Uruguay  71.342186    Netherlands    Netherlands       3
57          Spain       Paraguay  83.007655          Spain          Spain       3
58        Germany      Argentina  42.635127      Argentina        Germany       3
59          Ghana        Uruguay  41.784682        Uruguay           draw       1
60         Brazil    Netherlands  60.821972         Brazil    Netherlands       0
61       Portugal          Spain  23.464891          Spain          Spain       0
62          Japan       Paraguay  61.278000          Japan           draw       1
63          Chile         Brazil  24.459600         Brazil         Brazil       0
64       Slovakia    Netherlands  12.082967    Netherlands    Netherlands       0
65         Mexico      Argentina  17.626748      Argentina      Argentina       0
66        England        Germany  20.763176        Germany        Germany       0
67          Ghana            USA  71.310871          Ghana          Ghana       3
68    South Korea        Uruguay  45.148588        Uruguay        Uruguay       0
69         Brazil       Portugal  81.610878         Brazil           draw       1
70        Germany          Ghana  81.621494        Germany        Germany       3
71         Serbia      Australia  38.204905      Australia      Australia       0
72  CÃ´te d'Ivoire         Brazil  10.186423         Brazil         Brazil       0
73      Australia          Ghana  23.702414          Ghana           draw       1
74          Japan    Netherlands  10.773998    Netherlands    Netherlands       0
75         Serbia        Germany   4.731113        Germany         Serbia       3
76         Mexico         France  42.801515         France         Mexico       3
77    South Korea      Argentina  15.255040      Argentina      Argentina       0
78    Switzerland          Spain  18.747704          Spain    Switzerland       3
79       Portugal  CÃ´te d'Ivoire  65.031075       Portugal           draw       1
80       Paraguay          Italy  12.288896          Italy           draw       1
81      Australia        Germany   7.395354        Germany        Germany       0
82          Ghana         Serbia  83.682899          Ghana          Ghana       3
83            USA        England  34.763699        England           draw       1
84         France          Italy  28.651132          Italy           draw       1
85       Portugal        Germany  14.833907        Germany        Germany       0
86         France       Portugal  72.141913         France         France       3
87          Italy        Germany  33.364112        Germany          Italy       3
88         France         Brazil  22.742882         Brazil         France       3
89       Portugal        England  49.550454        England           draw       1
90        Ukraine          Italy  28.378865          Italy          Italy       0
91      Argentina        Germany  46.801014        Germany           draw       1
92         France          Spain  47.126654          Spain         France       3
93          Ghana         Brazil   9.144470         Brazil         Brazil       0
94        Ukraine    Switzerland  62.637340        Ukraine           draw       1
95      Australia          Italy   8.365416          Italy          Italy       0
96    Netherlands       Portugal  70.231295    Netherlands       Portugal       0
97        Ecuador        England  34.379086        England        England       0
98         Mexico      Argentina  29.233199      Argentina      Argentina       0
99         Sweden        Germany  10.914079        Germany        Germany       0
</code></pre>

<h3>Kodlar</h3>

<h3>world_cup.py</h3>

<div class="codehilite">
<pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Futbol maclarinin sonucunu lojistik regresyon kullanarak tahmin eder.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">987654321</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">987654321</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_curve</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>


<span class="k">def</span> <span class="nf">_drop_unbalanced_matches</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mac sirasinda her iki takim hakkinda elimide veri olmadigi icin,</span>
<span class="sd">    tarihi veride bir macta oynayan iki takimin ikisininde hakkinda veri</span>
<span class="sd">    yoksa o iki takimi egitim verisinden at. Bu durum eger bir takim hakkinda</span>
<span class="sd">    10 mactan daha az veri var ise ortaya cikabilir.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">skipped</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
                <span class="n">keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">skipped</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">skipped</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;matchid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;matchid&#39;</span><span class="p">]:</span>
            <span class="n">keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unexpected results&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="k">def</span> <span class="nf">_swap_pairwise</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; 0 ile 1, 2 ile 2, vs.. seklinda satir degis tokusu yap &quot;&quot;&quot;</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">col</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">col</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">col</span>


<span class="k">def</span> <span class="nf">_splice</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Bir maci temsil eden iki satiri tek bir satir olacak sekilde birlestir &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">opp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">opp_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;opp_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col</span><span class="p">,)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">opp</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">opp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">opp_cols</span>
    <span class="n">opp</span> <span class="o">=</span> <span class="n">opp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_swap_pairwise</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;opp_is_home&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opp</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_proportion</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bir dataframe&#39;i egitim set&#39;i ve test set&#39;i olarak ikiyi ayirir.</span>
<span class="sd">    Dikkatli olmak lazim cunku dataframe icinde bir macin satirlari ardi</span>
<span class="sd">    ardina gelmeli, bu sebeple bir macin tum verileri ya tamamen</span>
<span class="sd">    egitim ya da tamamen test set&#39;inde olmali.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">train_vec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unexpected data length&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_vec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">rnd</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="n">train_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rnd</span> <span class="o">&gt;</span> <span class="n">test_proportion</span><span class="p">)</span> 
        <span class="n">train_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rnd</span> <span class="o">&gt;</span> <span class="n">test_proportion</span><span class="p">)</span>

    <span class="n">test_vec</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">train_vec</span><span class="p">]</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">train_vec</span><span class="p">]</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">test_vec</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unexpected train length&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unexpected test length&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_extract_target</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_col</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Egitimde hedef olarak kullanilan kolonu dataframe&#39;den cikart.</span>
<span class="sd">    Geriye verilen dataframe eksi o kolonu dondur.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">train_df</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">target</span><span class="p">,</span> <span class="n">train_df</span>


<span class="k">def</span> <span class="nf">_check_eq</span><span class="p">(</span><span class="n">value</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Geriye oyle bir fonksiyon dondur ki gecilen tamsayi degerine (value) uyup</span>
<span class="sd">    uymadigini kontrol etsin. Dikkat, geriye gecilen degeri kontrol eden</span>
<span class="sd">    _fonksiyon_ donduruyoruz, o degeri burada kontrol etmiyoruz.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="n">L1_ALPHA</span> <span class="o">=</span> <span class="mf">16.0</span>
<span class="k">def</span> <span class="nf">build_model_logistic</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="mf">0.00000001</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">L1_ALPHA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bir lojistik regresyon modelini egitir. target parametresi</span>
<span class="sd">    hedef, yani etiket. target vektorunun satir sayisi data icindeki</span>
<span class="sd">    egitim verisinin satir sayisi kadar olmali.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">target</span><span class="o">==-</span><span class="mi">1</span><span class="p">):</span> <span class="n">target</span><span class="p">[</span><span class="n">target</span><span class="o">==-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">logit</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">Logit</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logit</span><span class="o">.</span><span class="n">fit_regularized</span><span class="p">(</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="n">acc</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">compute_auc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ikisel tahminleri kontrol et, karisiklik matrisi (confusion matrix) ve</span>
<span class="sd">    AUC hesaplar.</span>

<span class="sd">    Verili bir tahmin vektoru ve gercek degerlere bakarak tahminde ne kadar</span>
<span class="sd">    basarili oldugumuzu hesaplar.</span>

<span class="sd">    Argumanlar:</span>

<span class="sd">    label: kontrol ettigimiz seyin etiketi</span>
<span class="sd">    target: gercek degerlerin vektoru</span>
<span class="sd">    predictions: tahmin edilen degerleri - bu bir olasilik vektoru</span>
<span class="sd">       olabilir, ki bu durumda onu siralayip (sort) en emin olunan</span>
<span class="sd">       degerleri aliriz, emin olmak bir esik degerine gore hesaplanir.</span>
<span class="sd">       Tabii tahmin 1 ya da 0 ise direk dogru ya da yanlis sonucuna</span>
<span class="sd">       varabiliriz.</span>
<span class="sd">    compute_auc: Eger dogru ise tahminler icin bir AUC hesaplar.</span>
<span class="sd">       Bu arguman dogru ise tahminlerin de bir olasilik vektoru</span>
<span class="sd">       olmasi gerekir. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Length mismatch </span><span class="si">%d</span><span class="s1"> vs </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> 
                                                      <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">baseline</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="c1"># Baseline number is expected count, not proportion. Get the proportion.</span>
        <span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="n">zipped</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">predictions</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="o">-</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">expect</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">*</span> <span class="n">baseline</span>

    <span class="p">(</span><span class="n">true_pos</span><span class="p">,</span> <span class="n">true_neg</span><span class="p">,</span> <span class="n">false_pos</span><span class="p">,</span> <span class="n">false_neg</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)):</span>
        <span class="p">(</span><span class="n">yval</span><span class="p">,</span> <span class="n">prob</span><span class="p">)</span> <span class="o">=</span> <span class="n">zipped</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">predicted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">predicted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">predicted</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">expect</span>
        <span class="k">if</span> <span class="n">predicted</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">yval</span><span class="p">:</span>
                <span class="n">true_pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">false_pos</span> <span class="o">+=</span> <span class="mi">1</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">yval</span><span class="p">:</span>
                <span class="n">false_neg</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">true_neg</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">true_pos</span> <span class="o">+</span> <span class="n">false_neg</span>
    <span class="n">neg</span> <span class="o">=</span> <span class="n">true_neg</span> <span class="o">+</span> <span class="n">false_pos</span>
    <span class="c1"># P(1 | predicted(1)) and P(0 | predicted(f))</span>
    <span class="n">pred_t</span> <span class="o">=</span> <span class="n">true_pos</span> <span class="o">+</span> <span class="n">false_pos</span>
    <span class="n">pred_f</span> <span class="o">=</span> <span class="n">true_neg</span> <span class="o">+</span> <span class="n">false_neg</span>
    <span class="n">prob1_t</span> <span class="o">=</span> <span class="n">true_pos</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">pred_t</span> <span class="k">if</span> <span class="n">pred_t</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="n">prob0_f</span> <span class="o">=</span> <span class="n">true_neg</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">pred_f</span> <span class="k">if</span> <span class="n">pred_f</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="c1"># Lift = P(1 | t) / P(1)</span>
    <span class="n">prob_1</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">neg</span><span class="p">)</span>
    <span class="n">lift</span> <span class="o">=</span> <span class="n">prob1_t</span> <span class="o">/</span> <span class="n">prob_1</span> <span class="k">if</span> <span class="n">prob_1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">true_pos</span> <span class="o">+</span> <span class="n">true_neg</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">compute_auc</span><span class="p">:</span>
        <span class="n">y_bool</span> <span class="o">=</span>  <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">yval</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="p">(</span><span class="n">yval</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">]</span>
        <span class="n">x_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">xval</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">xval</span><span class="p">)</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">]</span>
        <span class="n">auc_value</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_bool</span><span class="p">,</span> <span class="n">x_vec</span><span class="p">)</span>
        <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_bool</span><span class="p">,</span> <span class="n">x_vec</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ROC </span><span class="si">%s</span><span class="s1"> (area = </span><span class="si">%0.2f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">auc_value</span><span class="p">))</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ROC curve&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">auc_value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.03g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">auc_value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">auc_value</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>

    <span class="nb">print</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">) Lift: </span><span class="si">%0.03g</span><span class="s1"> Auc: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">lift</span><span class="p">,</span> <span class="n">auc_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;    Base: </span><span class="si">%0.03g</span><span class="s1"> Acc: </span><span class="si">%0.03g</span><span class="s1"> P(1|t): </span><span class="si">%0.03g</span><span class="s1"> P(0|f): </span><span class="si">%0.03g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">baseline</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">prob1_t</span><span class="p">,</span> <span class="n">prob0_f</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;    Fp/Fn/Tp/Tn p/n/c: </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">false_pos</span><span class="p">,</span> <span class="n">false_neg</span><span class="p">,</span> <span class="n">true_pos</span><span class="p">,</span> <span class="n">true_neg</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">neg</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_coerce_types</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Bir liste icindeki tum degerlerin float (reel sayi) oldugunu kontrol et &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_coerce</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dataframe icindeki tum degerleri float&#39;a cevir ve degerleri</span>
<span class="sd">    standardize et</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_standardize</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_coerce_types</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_standardize_col</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Tek bir kolonu standardize et (ortalamayi cikar, standart sapma</span>
<span class="sd">        ile bol</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">std</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">col</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span><span class="o">/</span><span class="n">std</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">col</span>


<span class="k">def</span> <span class="nf">_standardize</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Tum dataframe&#39;i standardize et. Tum kolonlar sayisal olmali &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_standardize_col</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_clone_and_drop</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drop_cols</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Icinde belli bazi kolonlarin atildigi bir Dataframe&#39;in kopyasini dondur &quot;&quot;&quot;</span>
    <span class="n">clone</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">drop_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">clone</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">clone</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">clone</span>


<span class="k">def</span> <span class="nf">_normalize</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Listeyi normalize et ki toplami 1 olsun &quot;&quot;&quot;</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">val</span> <span class="o">/</span> <span class="n">total</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vec</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_games</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Tek sayili satirlari at. Bu fonksiyon faydali cunku bazen</span>
<span class="sd">        ardi ardina ayni mac hakkinda iki satira ihtiyacimiz olmuyor</span>
<span class="sd">        bir tanesi yeterli.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[[</span><span class="n">idx</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))]]</span> 


<span class="k">def</span> <span class="nf">_team_test_prob</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A takiminin B takimini, ve B takiminin A takimini yenme olasiliklarini</span>
<span class="sd">        hesapliyoruz. Her iki yondeki olasiliklari kullanarak genel</span>
<span class="sd">        bir olasilik hesabi yap.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">game0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="o">*</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">game1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">game0</span><span class="o">/</span><span class="p">(</span><span class="n">game0</span><span class="o">+</span><span class="n">game1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="k">def</span> <span class="nf">extract_predictions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Uyum verileri ve tahminleri iceren Dataframe&#39;leri birlestir.</span>
<span class="sd">         Geriye dondurulen DF icinde takim isimleri, tahminler, ve</span>
<span class="sd">         (eger mevcut ise) puan olarak sonuc. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">_team_test_prob</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
    <span class="n">teams0</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">teams1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">game</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;matchid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">game</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;matchid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">game</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unexpeted match id </span><span class="si">%d</span><span class="s1"> vs </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span>
                               <span class="n">data</span><span class="p">[</span><span class="s1">&#39;matchid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">game</span> <span class="o">*</span> <span class="mi">2</span><span class="p">],</span>
                               <span class="n">data</span><span class="p">[</span><span class="s1">&#39;matchid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">game</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">team0</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;team_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">game</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">team1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;op_team_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">game</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;points&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> 
            <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">game</span> <span class="o">*</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">teams0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">team0</span><span class="p">)</span>
        <span class="n">teams1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">team1</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;team_name&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">teams0</span><span class="p">),</span> 
         <span class="s1">&#39;op_team_name&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">teams1</span><span class="p">),</span>
         <span class="s1">&#39;predicted&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)},</span>
         <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;team_name&#39;</span><span class="p">,</span> <span class="s1">&#39;op_team_name&#39;</span><span class="p">,</span> <span class="s1">&#39;predicted&#39;</span><span class="p">])</span>

    <span class="n">expected_winner</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">game</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">game</span><span class="p">]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;team_name&#39;</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;predicted&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">50</span> <span class="k">else</span> <span class="s1">&#39;op_team_name&#39;</span> 
        <span class="n">expected_winner</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;expected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">expected_winner</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">winners</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">game</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">game</span><span class="p">]</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">game</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">point</span> <span class="o">&gt;</span> <span class="mf">1.1</span><span class="p">:</span>
                <span class="n">winners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;team_name&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">point</span> <span class="o">&lt;</span> <span class="mf">0.9</span><span class="p">:</span>
                <span class="n">winners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;op_team_name&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">point</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">:</span>
                <span class="n">winners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;draw&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">winners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NA&#39;</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;winner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="k">def</span> <span class="nf">_check_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Dataframe&#39;i gez ve her seyin iyi durumda olup olmadigini kontrol et &quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unexpeted length&#39;</span><span class="p">)</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;matchid&#39;</span><span class="p">]</span>
    <span class="n">teams</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;teamid&#39;</span><span class="p">]</span>
    <span class="n">op_teams</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;op_teamid&#39;</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">matches</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">matches</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Match mismatch: </span><span class="si">%s</span><span class="s1"> vs </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">matches</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">matches</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">teams</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">op_teams</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Team mismatch: match </span><span class="si">%s</span><span class="s1"> team </span><span class="si">%s</span><span class="s1"> vs </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">matches</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">teams</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                            <span class="n">op_teams</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">teams</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">op_teams</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Team mismatch: match </span><span class="si">%s</span><span class="s1"> team </span><span class="si">%s</span><span class="s1"> vs </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">matches</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">teams</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> 
                            <span class="n">op_teams</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>


<span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; birbiri ile uyan ama iki takim hakkinda veri olmadigi durumda o satirlari at&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">_drop_unbalanced_matches</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">_check_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ignore_cols</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Veri uzerinde bir lojistik regresyon modeli egitir. ignore_cols icinde</span>
<span class="sd">    gecilen kolonlar dikkate alinmaz. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate the data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">prepare_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;points&#39;</span>
    <span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">train</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;/tmp/out3.csv&#39;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">x_train</span><span class="p">)</span> <span class="o">=</span> <span class="n">_extract_target</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">target_col</span><span class="p">)</span>
    <span class="n">x_train2</span> <span class="o">=</span> <span class="n">_splice</span><span class="p">(</span><span class="n">_coerce</span><span class="p">(</span><span class="n">_clone_and_drop</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">ignore_cols</span><span class="p">)))</span>

    <span class="n">y_train2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">yval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">yval</span> <span class="ow">in</span> <span class="n">y_train</span><span class="p">]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">build_model_logistic</span><span class="p">(</span><span class="n">y_train2</span><span class="p">,</span> <span class="n">x_train2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">8.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">predict_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">ignore_cols</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bir takimin kazanip kazanmayacaginin tahmin eden basit bir algoritma</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x_test</span> <span class="o">=</span> <span class="n">_splice</span><span class="p">(</span><span class="n">_coerce</span><span class="p">(</span><span class="n">_clone_and_drop</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">ignore_cols</span><span class="p">)))</span>
    <span class="n">x_test</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">predicted</span> <span class="o">=</span>  <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;predicted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predicted</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre>
</div>

<h3>power.py</h3>

<div class="codehilite">
<pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Futbol takimlarin gecmiste oynadiklari maclara gore bir guc indisi atayarak</span>
<span class="sd">derecelendirir.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">LinAlgError</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">world_cup</span>

<span class="k">def</span> <span class="nf">_build_team_matrix</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_col</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verili bir mac dataframe&#39;ine gore bir seyrek guc matrisi yaratir.</span>
<span class="sd">    Girdi verisinde her mac icin arka arkaya iki tane satir kaydi olmasini</span>
<span class="sd">    bekliyoruz. Ilk satir deplasman takimi hakkinda bilgi tasiyacak,</span>
<span class="sd">    ikinci satir konuk takim hakkinda. Hesap yapilan matriste takimlar kolonlarda</span>
<span class="sd">    maclar ise satirlarda olacak. Her mac icin deplasman takiminin</span>
<span class="sd">    kolonunda pozitif bir deger olacak. Konuk takim icin negatif bir deger</span>
<span class="sd">    olacak. Futbolde deplasman avantaji cok onemli oldugu icin</span>
<span class="sd">    bu deplasmanda oynayan takimdan biraz avantaj cikartiyoruz. Tabii</span>
<span class="sd">    burada dikatli olmak ta lazim, cunku dunya kupasi icin is_home (deplasman mi?)</span>
<span class="sd">    kolonu evet/hayir formatinda degil (0.0 ile 1.0 arasinda reel degerler).</span>
<span class="sd">    Guc matrisindeki en son kolon bir puan matrisi, bu kolona</span>
<span class="sd">    deplasman takimi ile konuk takimin hedef kolonlari arasindaki fark</span>
<span class="sd">    yazilmis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">teams</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">teamid</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;teamid&#39;</span><span class="p">]:</span>
        <span class="n">teams</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">teamid</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nrows</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nrows</span><span class="p">))</span>
    <span class="n">teams</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

    <span class="n">current_season</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">current_discount</span> <span class="o">=</span> <span class="mf">2.0</span>

    <span class="k">for</span> <span class="n">game</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
        <span class="n">home</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">game</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">away</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">game</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">home</span><span class="p">[</span><span class="s1">&#39;seasonid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">current_season</span><span class="p">:</span>
            <span class="c1"># Discount older seasons.</span>
            <span class="n">current_season</span> <span class="o">=</span> <span class="n">home</span><span class="p">[</span><span class="s1">&#39;seasonid&#39;</span><span class="p">]</span>
            <span class="n">current_discount</span> <span class="o">*=</span> <span class="mf">0.6</span>
            <span class="nb">print</span> <span class="s2">&quot;New season </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_season</span><span class="p">,)</span>

        <span class="n">home_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">home</span><span class="p">[</span><span class="s1">&#39;teamid&#39;</span><span class="p">])</span>
        <span class="n">away_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">away</span><span class="p">[</span><span class="s1">&#39;teamid&#39;</span><span class="p">])</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">home</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">away</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span>

        <span class="c1"># Discount home team&#39;s performance.</span>
        <span class="n">teams</span><span class="p">[</span><span class="n">home_id</span><span class="p">][</span><span class="n">game</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">home</span><span class="p">[</span><span class="s1">&#39;is_home&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="o">.</span><span class="mi">25</span><span class="p">)</span> <span class="o">/</span> <span class="n">current_discount</span>
        <span class="n">teams</span><span class="p">[</span><span class="n">away_id</span><span class="p">][</span><span class="n">game</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">away</span><span class="p">[</span><span class="s1">&#39;is_home&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="o">.</span><span class="mi">25</span><span class="p">)</span> <span class="o">/</span> <span class="n">current_discount</span>
        <span class="n">result</span><span class="p">[</span><span class="n">game</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">teams</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_build_power</span><span class="p">(</span><span class="n">games</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">coerce_fn</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Birbiri ile alakali bir kume mac uzerinden bir guc modeli</span>
<span class="sd">        hazirlar (tum bu maclar ayni turnuvadan, musabakadan olmalidir mesela).</span>
<span class="sd">        Bu maclar ve onlarin sonucunu alarak bu fonksiyon bir lojistik</span>
<span class="sd">        regresyon modeli kurar, ve bu model tum takimlarin birbirine</span>
<span class="sd">        olan izafi bir siralamasini hesaplar. Geriye takim id&#39;si ve</span>
<span class="sd">        o takimin 0 ve 1 arasindaki bir guc indisini dondurur. Eger</span>
<span class="sd">        snap degiskeni True ise, indisler ceyreklere bolunur. Bu faydali</span>
<span class="sd">        cunku siralama tahmini oldukca kabaca yapilan bir tahmin ve</span>
<span class="sd">        tek bir numaradan elde edilecek bir tur &quot;asiri spesifiklik&quot; </span>
<span class="sd">        bizi yaniltabilirdi. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outcomes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">coerce_fn</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">outcomes</span><span class="p">])</span>
    <span class="n">games</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;/tmp/games.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">outcomes</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;/tmp/outcomes.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">world_cup</span><span class="o">.</span><span class="n">build_model_logistic</span><span class="p">(</span><span class="n">outcomes</span><span class="p">,</span> <span class="n">games</span><span class="p">,</span> 
        <span class="n">acc</span><span class="o">=</span><span class="n">acc</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="c1">#print model.summary()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">params</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="n">max_param</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">min_param</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">param_range</span> <span class="o">=</span> <span class="n">max_param</span> <span class="o">-</span> <span class="n">min_param</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">param_range</span> <span class="o">&lt;</span> <span class="mf">0.0001</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">min_param</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">param_range</span><span class="p">)</span>
    <span class="n">qqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">_snap</span><span class="p">(</span><span class="n">val</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot; Snaps a value to a quartile. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qqs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">qqs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">val</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">idx</span> <span class="o">*</span> <span class="mf">0.25</span>
        <span class="k">return</span> <span class="mf">1.0</span>

    <span class="k">if</span> <span class="n">snap</span><span class="p">:</span>
        <span class="c1"># Snap power data to rough quartiles.</span>
        <span class="k">return</span> <span class="n">params</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_snap</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">params</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_get_power_map</span><span class="p">(</span><span class="n">competition</span><span class="p">,</span> <span class="n">competition_data</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">coerce_fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Verili bir musabakadaki maclar ve sonuclarini iceren hedef kolonlarini</span>
<span class="sd">       kullanarak tum bu takimlarin guc siralamasini hesapla. Uyum biraz</span>
<span class="sd">       gevsek olacaktir, evet, bu sebeple uydurma islemini farkli</span>
<span class="sd">       regularizasyon ve alpha parametreleri ile birkac kez denememiz</span>
<span class="sd">       gerekebilir, ki boylece uydurmanin yakinsamasini (converge)</span>
<span class="sd">       elde edebilmis oluruz. Geriye takim id ve guc siralamsini dondurur.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="mf">0.000001</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">alpha</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Skipping power ranking for competition </span><span class="si">%s</span><span class="s2"> column </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">competition</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">games</span> <span class="o">=</span> <span class="n">_build_team_matrix</span><span class="p">(</span><span class="n">competition_data</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="n">outcomes</span> <span class="o">=</span> <span class="n">games</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">games</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">competition_power</span> <span class="o">=</span> <span class="n">_build_power</span><span class="p">(</span><span class="n">games</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">coerce_fn</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span>
                                             <span class="n">alpha</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">competition_power</span><span class="p">:</span>
                <span class="n">alpha</span> <span class="o">/=</span> <span class="mi">2</span>
                <span class="nb">print</span> <span class="s1">&#39;Reducing alpha for </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%f</span><span class="s1"> due lack of range&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">competition</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">competition_power</span>
        <span class="k">except</span> <span class="n">LinAlgError</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">/=</span> <span class="mi">2</span>  
            <span class="nb">print</span> <span class="s1">&#39;Reducing alpha for </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%f</span><span class="s1"> due to error </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">competition</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add_power</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">power_train_data</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dataframe&#39;e bazi guc kolonlari ekliyor. Egitim power_train_data</span>
<span class="sd">        verisini musabakalara boler (cunku bu parcalar birbirinden farkli</span>
<span class="sd">        guc istatistigine sahip olacaktir; mesela EPL takimlari MLS takimlari</span>
<span class="sd">        ile normal lig maclarinda oynamazlar), hangi takimin daha fazla ya da</span>
<span class="sd">        az guclu olup olmadigini bu maclar bazinda anlamak faydali olmazdi.</span>

<span class="sd">        cols icinde bir kolon ismi olacak, ki bu kolon tahmin etmek</span>
<span class="sd">        icin kullanilacak, bir fonksiyon ki onceden bahsedilen kolondaki</span>
<span class="sd">        farki irdelemekle gorevli, ve sonucun yazilacagi hedef kolon.</span>

<span class="sd">        Geriye bir dataframe dondurur, bu dataframe &#39;data&#39; parametresiyle</span>
<span class="sd">        ayni boyutlardadir, sadece ekl olarak guc istatistigi eklemis olacaktir.</span>
<span class="sd">    &quot;&quot;&quot;</span>   
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">competitions</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;competitionid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">coerce_fn</span><span class="p">,</span> <span class="n">final_name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">power</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">competition</span> <span class="ow">in</span> <span class="n">competitions</span><span class="p">:</span>
            <span class="n">competition_data</span> <span class="o">=</span> <span class="n">power_train_data</span><span class="p">[</span>
                <span class="n">power_train_data</span><span class="p">[</span><span class="s1">&#39;competitionid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">competition</span><span class="p">]</span>
            <span class="n">power</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">_get_power_map</span><span class="p">(</span><span class="n">competition</span><span class="p">,</span> <span class="n">competition_data</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">coerce_fn</span><span class="p">))</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">power_col</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">teamid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;teamid&#39;</span><span class="p">])</span>
            <span class="n">names</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;team_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">teamid</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">power_col</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">power</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">teamid</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%0.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
               <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">names</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;power_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">final_name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">power_col</span>
    <span class="k">return</span> <span class="n">data</span>
</code></pre>
</div>

<h3>features.py</h3>

<div class="codehilite">
<pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mac hakkindaki ham veriyi tahmin icin kullanabilecegimiz</span>
<span class="sd">    ozelliklere donusturur. Tarihi verideki birkac maci birlestirip</span>
<span class="sd">    birlesik / ozetsel bazi hesaplar uret ki boylece sonraki maci</span>
<span class="sd">    tahmin edebilelim.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">match_stats</span>

<span class="k">def</span> <span class="nf">get_wc_features</span><span class="p">(</span><span class="n">history_size</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;results-20140714-123022.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_features</span><span class="p">(</span><span class="n">history_size</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;results-20140714-123519.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_game_summaries</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;results-20140714-124014.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</code></pre>
</div>

<h3>match_stats.py</h3>

<div class="codehilite">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_non_feature_columns</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Ozellikler dataframe&#39;inin kolon isimlerini dondur. Bu dataframe</span>
<span class="sd">    tahmin icin kullanilmayan bir dataframe; kolonlari metaveri</span>
<span class="sd">    aslinda (yani veri hakkinda veri), mesela takim ismi gibi, ya da</span>
<span class="sd">    regresyon icin kaynak degil hedef veri iceren kolonlar. Hedef kolonunu</span>
<span class="sd">    kullanmak istemiyoruz cunku bir macin verisini kullanarak ayni maci tahmin</span>
<span class="sd">    ettigimiz bir durumda olmak istemeyiz.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;teamid&#39;</span><span class="p">,</span> <span class="s1">&#39;op_teamid&#39;</span><span class="p">,</span> <span class="s1">&#39;matchid&#39;</span><span class="p">,</span> <span class="s1">&#39;competitionid&#39;</span><span class="p">,</span> <span class="s1">&#39;seasonid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;goals&#39;</span><span class="p">,</span> <span class="s1">&#39;op_goals&#39;</span><span class="p">,</span> <span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;team_name&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;op_team_name&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_feature_columns</span><span class="p">(</span><span class="n">all_cols</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tahminde kullanilmasi gereken tum kolonlari geri dondurur, mesela</span>
<span class="sd">    mesela dataframe&#39;de olan ama features.get_non_feature_column() icinde</span>
<span class="sd">    olmayan tum ogeler (kolonlar)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">all_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">get_non_feature_columns</span><span class="p">()]</span>
</code></pre>
</div>

<p>Kaynaklar</p>

<p>[1] Google Cloud Platform Blog,
    Google Cloud Platform goes 8 for 8 in World Cup predictions,
    http://googlecloudplatform.blogspot.de/2014/07/google-cloud-platform-goes-8-for-8-in-soccer-predictions.html</p>

<p>[2] Google Cloud Platform,
    Sample iPython notebook with soccer predictions,
    https://github.com/GoogleCloudPlatform/ipython-soccer-predictions</p>

<p>[3] Google, Predicting the World Cup with the Google Cloud Platform,
    http://nbviewer.ipython.org/github/GoogleCloudPlatform/ipython-soccer-predictions/blob/master/predict/wc-final.ipynb</p>

        </section>          
      </div>
    </body>
</html>
