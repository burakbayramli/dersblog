<p><a href="..">Yukarı</a></p>
<h1>Zaman Serisi Veri Analizi</h1>
<!DOCTYPE html>
<html>
  <head>
    <title>Zaman Serisi Veri Analizi
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [["$","$"]]}
      });
    MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
      MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
        cancel: ["Extension","cancel"],
        bcancel: ["Extension","cancel"],
        xcancel: ["Extension","cancel"],
        cancelto: ["Extension","cancel"]
      });
    });
    </script>
<script type="text/javascript"
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_HTML-full">
</script>
</head>

<p>Daha fazla ilerlemeden bu yazıda bazı veri işlem numaraları göreceğiz.</p>
<p>Durağanlık</p>
<p>Yapay Öğrenim (machine learning) ya da diğer istatistiki tahminsel yaklaşımlar
çoğunlukla işledikleri verinin durağan olmasının beklerler [1]. Durağanlık zaman
serisindeki her veri noktasının diğerleri ile aynı dağılıma sahip olması
demektir. Bu durum yoksa algoritmalar için bu rahatsızlık yaratır. Ve zaman
serilerinde durağanlık olmaması pek çok kez ortaya çıkar; serilerde bazen
sezonşallık görülür, bazen trend mevcuttur vs. O zaman durağan olmayan serileri
durağan hale getirmek zaman serisi analizi, tahmininde önemli bir beceri
olacaktır.</p>
<p>Alttaki resimlere bakalım ve hangisinin durağan olduğunu tahmin etmeye
uğraşalım. </p>
<p><img alt="" src="tser_008_data_01.png" /></p>
<p>Durağan serilerin sabit varyansı olduğuna göre a,c,e,f ve i resimlerini
atabiliriz. Bu seriler ya net bir yukarı ya da aşağı trend içeriyorlar ya
da seviyelerde değişim var, mesela f örneğindeki gibi.</p>
<p>d ve h içinde sezonsal kalıplar var, onları da atıyoruz. Ya peki g?  Sanki
sezonsal bir kalıp varmış gibi duruyor fakat bu doğru değil.  Bu seri vasak
denen hayvanların nüfusunu gösteriyor, yiyecek azalınca hayvanlar azalıyor,
yiyecek varsa nüfus artıyor, bu tür tekrar eden bir süreç sezonşallıkla aynı şey
değil. Sezonşallık varsa herhangi bir zaman diliminde ne olacağını kesinlikle
biliyoruz. Kıyasla vasak nüfusunun artış azalış tekrarı tahmin edilebilir
değil.</p>
<p>O zaman eldeki tek durağan seri b ve g.</p>
<p>Testler</p>
<p>Durağanlığı bulmak için bazı istatistiki testler var, bu testlere birim kök
(ünit root) testleri adı veriliyor, en popüleri olanı eklemlenmiş Dickey-Fuller
testi. Bu teste göre sıfır hipotezi serinin durağan olmadığıdır, o zaman bu
hipotez reddedilirse, mesela 0.05, ya da 0.01'den az bir p-değeri elde edilirse,
bu demektir ki elde bir durağan seri var. </p>
<p>Ornek olarak elmasla verisine bakalim,</p>
<pre><code class="python">import seaborn as sns
from statsmodels.tsa.stattools import adfuller
diamonds = sns.load_dataset(&quot;diamonds&quot;)
test_results = adfuller(diamonds[&quot;price&quot;])
print(f&quot;ADF test statistic: {test_results[0]}&quot;)
print(f&quot;p-value: {test_results[1]}&quot;)
print(&quot;Critical thresholds:&quot;)
for key, value in test_results[4].items():
    print(f&quot;\t{key}: {value}&quot;)
</code></pre>

<pre><code>ADF test statistic: -8.11493066831561
p-value: 1.1980457313375998e-12
Critical thresholds:
    1%: -3.430471308341908
    5%: -2.8615936158814588
    10%: -2.566798537945544
</code></pre>

<p>p-degerine bakiyoruz, neredeyse sifir. O zaman H0 reddedildi, seri duragan.</p>
<p>Şimdi büyük ihtimalle durağan olmayan bir seriye bakalım,</p>
<pre><code class="python">import pandas as pd
df = pd.read_csv('AAPL.csv',index_col=0)
df.plot()
plt.savefig('tser_008_data_04.png')
</code></pre>

<p><img alt="" src="tser_008_data_04.png" /></p>
<p>Şeride açık bir yukarı doğru trend var. Test edelim,</p>
<pre><code class="python">adfuller(df)[1]
</code></pre>

<pre><code>Out[1]: 0.9069640607490215
</code></pre>

<p>Sıfırdan çok uzak bir p-değeri bu, demek ki seri durağan değil.</p>
<p>Bir seriyi duragan hale getirmek icin kullanilan en basit yontem fark
almaktir, yani serideki her veri noktasini bir oncekinden cikartmak. Mesela
ustteki AAPL sent verisi icin bunu yaparsak ve testi tekrar uygularsak,</p>
<pre><code class="python">import pandas as pd
d1 = df.diff().dropna()
d1.plot()
plt.savefig('tser_008_data_03.png')
</code></pre>

<p><img alt="" src="tser_008_data_03.png" /></p>
<pre><code class="python">from statsmodels.tsa.stattools import adfuller
adfuller(d1)[1]
</code></pre>

<pre><code>Out[1]: 9.132206809895503e-19
</code></pre>

<p>p-değeri çok küçük, demek ki farkı alınmış seri durağan hale geldi.</p>
<p>Fark alma ne işlemini yapıyor? Bu işlemin ne olduğunu görmek zor değil, fark
alma işlemlerini bir türevi yaklaşık olarak temsil eden bir işlem olarak
görebiliriz, </p>
<p>$$
\frac{f(x)-f(x+\Delta)}{\Delta}
$$</p>
<p>ki $\Delta$ değerleri 1'de sabitlenmiş oluyor (ve yokolur) ve bir sonraki
$f(x)$'e ulaşmak için sabit artış farzedersek o zaman zaman serisinde fark almak
bir tür türev almakla eşdeğerdir. Bu sebeple basit fark işlemi trendi çıkartır,
eğer elde gürültülü bir $y = ax + b$ var ise türev sonrası elde $a$ eğimi
ve gürültü kalacaktır.</p>
<p>Tabii gürültülü bir veride yaklaşık bir işlem yapıyoruz, eğer hakikaten trendi
genel eğim üzerinden çıkartmak istersek, veri üzerinde lineer regresyon
yapabilirdik,</p>
<pre><code class="python">import pandas as pd
df = pd.read_csv('AAPL.csv').reset_index()
import statsmodels.formula.api as smf
results = smf.ols('AAPL ~ index', data=df).fit()
df['AAPL Trendsiz'] = results.resid
df[['AAPL','AAPL Trendsiz']].plot()
plt.savefig('tser_008_data_02.png')
</code></pre>

<p><img alt="" src="tser_008_data_02.png" /></p>
<p>Trend çıkarılmış grafik için <code>resid</code> verisi kullanıldı çünkü bu değişken
içinde model ile gerçek değerler arasındaki fark, 'artıklar' gösteriliyor, ki bu
dolaylı olarak veriden trend çıkartılmış hal demektir.</p>
<p>[devam edecek]</p>
<p>Kaynaklar</p>
<p>[1] <em>How to Remove Non-Stationarity From Time Series</em>,
    <a href="https://www.kaggle.com/code/bextuychiev/how-to-remove-non-stationarity-from-time-series?scriptVersionId=73876070">https://www.kaggle.com/code/bextuychiev/how-to-remove-non-stationarity-from-time-series?scriptVersionId=73876070</a></p>
<p>[2] Stackexchange,
    <a href="https://stats.stackexchange.com/questions/200517/why-does-differencing-once-remove-not-only-linear-but-also-nonlinear-trends">https://stats.stackexchange.com/questions/200517/why-does-differencing-once-remove-not-only-linear-but-also-nonlinear-trends</a></p>