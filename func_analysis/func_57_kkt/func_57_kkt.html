<h1>Karush-Kuhn-Tucker (KKT) Şartları</h1>
<!DOCTYPE html>
<html>
  <head>
    <title>Karush-Kuhn-Tucker (KKT) Şartları
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [["$","$"]]}
      });
    MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
      MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
        cancel: ["Extension","cancel"],
        bcancel: ["Extension","cancel"],
        xcancel: ["Extension","cancel"],
        cancelto: ["Extension","cancel"]
      });
    });
    </script>
<script type="text/javascript"
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_HTML-full">
</script>
</head>

<p>KKT şartları birkaç basit kavramın bir araya gelmesiyle oluşan çok kuvvetli
bir kavram. Bu şartlar 4 tane. Alttaki gibi genel bir problemle bağlantılılar,</p>
<p>$$
\min_x f(x) \quad \textrm{öyle ki}
$$
$$
h_i(x) \le 0, \quad i=1,..,m
$$
$$
l_j(x) = 0, \quad j=1,..,r
$$</p>
<p>Lagrangian'ı hatırlarsak, </p>
<p>$$
L(x,u,v) =  f(x) + 
\sum_{i=1}^{m} u_i \underbrace{h_i(x)}_{\le 0} + 
\sum_{i=1}^{r} v_i \underbrace{l_i(x)}_{=0}
$$</p>
<p>Problemin dışbükey olması mecbur değil. </p>
<p>Bu şartlar,</p>
<p>1) Durağanlık şartı</p>
<p>Lagrangian'da $u,v$ sabitledim, ve $x$'e göre Lagrangian'ın altgradyanını
alırsam, 0 değeri bu altgradyan içinde olmalı. </p>
<p>$$
0 \in \partial_x \left(
f(x) + \sum_{i=1}^{m} u_i h_i(x) + \sum_{j=1}^{r} v_j l_j(x) 
\right)
$$</p>
<p>2) Tamamlayıcı Gevşeklik (Complementary Slackness)</p>
<p>$$
u_i \cdot h_i(x) = 0 \quad \forall i
$$</p>
<p>Üstteki şart diyor ki ya $h_i(x)$ sıfır olmalı, yani $i$'inci eşitsizlik
sıkı olmalı, ya da ona tekabül eden ikiz değişken $u_i$ sıfır olmalı, yani
eşitsizlik ya sıkı -eşitlik- ya da dikkate alınmamalı.</p>
<p>3) Ana Olurluk</p>
<p>$$
h_i(x) \le 0, \quad l_j(x) = 0 \quad \forall i,j
$$</p>
<p>4) İkiz Olurluğu</p>
<p>$$
u_i \ge 0, \quad \forall i
$$</p>
<p>Optimallik için $x,u,v$ üstteki 4 şartı yerine getirmeli, genel bağlamda bu
o $x$'in ana problemi, $u,v$'nin ikiz problemi çözmesi anlamına geliyor. </p>
<p>İspatlayalım. Önce ters yönden gelerek bir ispat, diyelim ki elimde ana ve
ikiz çözümler var. Eğer o "çözüm varsa, oradan KKT şartları meydana
çıkmalı" ispatını görelim. Bu yöne "gereklilik" (necessary)
denebilir. Diyelim ki $x^*$, ve $u^*,v^*$ ana ve ikiz çözümleri var, ve
ikizlik boşluğu sıfır (yani güçlü ikizlik aktif, Slater şartını
hatırlarsak). O zaman</p>
<p>$$
f(x^*) = g(u^*,v^*)
$$</p>
<p>Tanım itibariyle, her $u,v$ için $g(u,v)$ fonksiyou Lagrangian'ın $x$
üzerinden minimumu. Üsttekinden hareketle ve $u,v$ için $u^*,v^*$
kullanırsak,</p>
<p>$$
= \min_x f(x) + \sum_{i=1}^{m} u_i^* h_i(x) + \sum_{j=1}^{r} v_j^* l_j(x) 
$$</p>
<p>Üstte minimum buluyorum yani $x$ üzerinden üstteki Lagrangian'ı $x^*$'deki
halinden daha fazla ufaltmam mümkün değil,</p>
<p>$$
\le f(x^*) + \sum_{i=1}^{m} u_i{^*} h_i(x^*) + \sum_{j=1}^{r} v_j{^*} l_j(x^*) 
\qquad (1)
$$</p>
<p>Devam edersek, $u_i^*$ olurlu, o zaman üstteki ortadaki terim $\ge 0$,
$v_i^*$ olurlu o zaman üçüncü terim sıfır. Bu demektir ki üstteki ifade
$f(x^*)$'den daha az olmalı.</p>
<p>$$
\le f(x^*) 
\qquad (2)
$$</p>
<p>Sonuç olarak </p>
<p>$$
f(x^*) \le f(x^**)
$$</p>
<p>elde ettik, o zaman üstteki ifade aslında eşitsizlik değil bir eşitlik
çünkü eşitsizliğin iki tarafında aynı şey var. </p>
<p>Eşitsizliklerin eşitlik olması ne anlama gelir? Demek ki $x^*$ Lagrangian'ı
$u^*,v^*$ noktasında minimize edecektir. Durağanlık bu demek zaten değil
mi? $x$'e göre Lagrangian'ın altgradyanını aldım ve bu sıfıra eşit.  Ayrıca
tamamlayan gevşeklik şartı da ispatlanmış oluyor, (1) ile (2) eşit
olmalıysa, ve (1)'deki 3. terimin sıfır olduğunu biliyoruz, 2. terimdeki
tamamı pozitif olan toplam öğeleride sıfır olmalı çünkü başka türlü (2)'ye
eşitliği elde edemeyiz. Eh bu durum da tamamlayan gevşeklik şartı değil
midir?</p>
<p>Ana-ikiz olurluğunu zaten bedava elde ettik. Elimizde bir çözüm varsa onlar
ana-ikiz olurlu olmalı. </p>
<p>Yani ispatlamış olduk ki eğer elimizde ana-ikiz boşluğu olmayan bir çözüm
varsa, $x^*,u^*,v^*$ çözüm üçlüsü KKT koşullarına uymaktadır. KKT
koşularının güçlü ikizlik durumunda şart olduğunu göstermiş olduk.</p>
<p>Diğer yönden ispat etmeye uğraşalım. </p>
<p>Elimizde KKT şartlarını tatmin eden bir $x^*,u^*,v^*$ üçlüsü olduğunu
düşünelim, ve bu üçlünün optimal olması gerektiğini ispat edelim, yani
$x^*$'in ana $u^*,v^*$'nin ikiz problem için optimal olması
gerektiğini.. Eğer $x^*,u^*,v^*$ KKT şartlarına uygunsa, durağanlığa göre</p>
<p>$$
g(u^*,v^*) = f(x^*) + \sum_{i=1}^{m} u_i{^*} h_i(x^*) + \sum_{j=1}^{r} v_j{^*} l_j(x^*) 
\qquad (3)
$$</p>
<p>Bu tabii $g$ tanımı ile bağlı,</p>
<p>$$
g(u^*,v^*) = \min_x L(x,u^*,v^*)
$$</p>
<p>ve durağanlıkla </p>
<p>$$
= \min_x L(x^*,u^*,v^*)
$$</p>
<p>böylece üç üstteki tanım ortaya çıkıyor. </p>
<p>(3) içindeki ikinci terimde tamamlayıcı gevşekliği uygularsak toplamdaki
her öge $x^*$ için sıfır, toplam sıfır, ikinci terim tamamen sıfır.</p>
<p>KKT koşullarından bir diğeri olurluk, o zaman (3)'teki üçüncü terimde her
toplam öğesi sıfır, toplam sıfır. Geriye tek kalan</p>
<p>$$
g(u^*,v^*) = f(x^*) + 
\cancel{\sum_{i=1}^{m} u_i{^*} h_i(x^*)} + 
\cancel{\sum_{j=1}^{r} v_j{^*} l_j(x^*)}
$$</p>
<p>$$
= f(x^*)
$$</p>
<p>Eğer $g(u^*,v^*) = f(x^*)$ ise o zaman ana ve ikiz kriter arasında ikizlik
boşluğu yoktur demektir, ve daha önce gördüğümüz gibi bu elimizdekinin bir
çözüm olduğunun işaretidir. </p>
<p>Yani birkaç farklı yönden gelerek ispatladık ki $x^*$ ve $u^*,v^*$ KKT
koşullarına uyuyorsa, o zaman elimizdekiler optimal ana ve ikiz
çözümleridir. KKT koşulları her zaman yeterlidir. Dikkat edilirse
dışbükeylikten hiç bahsetmedik, KKT yeterli (sufficient), onlara uygunluk
varsa optimal ana ve ikiz çözüme erişmişiz demektir. Gereklilik (necessary)
durumu eğer güçlü dışbükeylik varsa, elimizdeki çözüm KKT koşullarına da
uymaya mecbur. Biraz söz cambazlığı gibi gelebilir ama tanımların net
olması, ve ilerideki teorilere faydası açısından bu iyi. </p>
<p>Soru</p>
<p>Eğer KKT koşullarını tatmin etmek optimallik için yeterliyse dünyadaki her
problemi KKT üzerinde rahatça çözebilir miyim?</p>
<p>Hayır çünkü 1. KKT şartı, durağanlık şartıyla problem çıkabilir. Pürüzsüz
bir problem için durağanlık için $f$ ve $h_i,l_i$'in gradyanlarını almam
yeter, sıfıra eşitlerim vs. Bir de dışbükeylik varsa tipik olarak
altgradyanı yazmak basittir. Sonucu bulmak her zaman kolay olmayabilir ama
en azından durağanlığı formülize etmek kolaydır. Fakat bazı fonksiyonlarda
dışbükeylik yoksa altgradyanları hesaplamanın zorluğu ötesinde bazen
altgradyan olmayabilir bile. Genelde pürüzsüz durumlarda KKT koşullarını
kullanmanın zor tarafı budur.</p>
<p>Bu sebeple formel bir uyarıyı slaytlara koyduk, "eğer $f$ dışbükey değilse
türevi alınabilir bir $f$ için bile direk $\partial f = {\nabla f(x)}$
diyemeyiz". </p>
<p>Eğer ana problemde hiçbir kısıtlama olmasaydı o zaman 2. 3. ve 4. KKT
şartları yokoluyor bu normal çünkü ikiz değişken olmayacak, 1. şarttaki
2. ve 3. terim yokolur, sadece altgradyanın sıfırı içerme şartı geriye
kalıyor. Bazen bilimcilerin bu tür problemlerde salt altgradyan optimalliği
kullanıp "KKT koşulları kullandım" dediğini duyabilirsiniz, ben bile
dalgınlıkla bunu söyleyebiliyorum bazen. Fonksiyon var, altgradyanını alıp
sıfıra eşitliyorum, bu "KKT koşulu" diyorum. Teknik olarak doğru tabii,
sadece KKT'nin çok basit bir hali bu.</p>
<p>Örnek</p>
<p>Eşitlik şartları olan karesel bir fonksiyonun minimizasyonuna bakalım. </p>
<p>$$
\min_x \frac{1}{2} x^T Q x + c^T x \quad \textrm{öyle ki}
$$
$$
Ax = 0
$$</p>
<p>$Q \succ 0$ olacak, yani $Q$ pozitif yarı-kesin, o zaman üstteki problem
dışbükey. Eşitsizlik şartı yok.</p>
<p>KKT şartlarını yazalım. Lagrangian nedir? </p>
<p>$$
L(x,u) = \frac{1}{2} x^T Q x + c^T x + u^T A x
$$</p>
<p>Durağanlık için üsttekinin gradyanını alıp sıfıra eşitlerim, </p>
<p>$$
Qx + c + A^T u = 0
$$</p>
<p>Tamamlayıcı gevşeklik</p>
<p>(Boş, çünkü eşitsizlik şartları yok)</p>
<p>Ana-ikiz olurluk</p>
<p>İkiz olurluk boş, çünkü eşitsizlik yok, yani $u$'nin pozitif olma şartı
yok. Ana olurluk ise </p>
<p>$$
Ax = 0
$$</p>
<p>Biliyoruz ki üstteki iki şartı tatmin edersem $x$ ana, $u$ ikiz optimal
çözüm olacak. </p>
<p>Güzel değil mi? Hatta bu lineer bir sistem olarak yazılabilir,</p>
<p>$$
\left[\begin{array}{ccc}
Q &amp; A^T \\ A &amp; 0
\end{array}\right]
\left[\begin{array}{c}
x \\ u
\end{array}\right] =
\left[\begin{array}{r}
-c \\ 0
\end{array}\right] 
$$</p>
<p>Eğer üstteki sistemi $x,u$ bulmak için çözersem, optimal noktaları
bulabilirim. Eğer matris tersi alınabilir ise tersini alırım, eşitliğin
sağındaki ifade ile çarparım, bu bana ana-ikiz sonucu verir. </p>
<p>Üstteki matrise bazen KKT matrisi deniyor, KKT koşullarını kullanarak
oluşturulduğu için. </p>
<p>[atlandı, su doldurma problemi, SVM]</p>
<p>Ekler</p>
<p>Örnek</p>
<p>Şimdi [2]'den alınan bir örneği görelim. </p>
<p>$$
\min_{x_1,x_2} x_1^2 + x_2^2 \quad \textrm{öyle ki}
$$
$$
x_1 + x_2 = 5
$$</p>
<p>Burada bir eşitlikle kısıtlanmış QP (equality constrained QP) var ve biraz
önce gördüğümüz KKT matrisini oluşturarak onu tek adımda çözebiliriz. 
Kriter ve kısıtlama matris formunda şöyle, $x = (x_1,x_2)$ alırsak,</p>
<p>$$
f(x) = \frac{1}{2} x^T 
\underbrace{
\left[\begin{array}{cc}
2 &amp; 0 \\ 0 &amp; 2
\end{array}\right]}_{Q} x + 
\left[\begin{array}{cc}
0 &amp; 0
\end{array}\right]^T x
$$
$$
\underbrace{
\left[\begin{array}{cc}
1 &amp; 1
\end{array}\right]}_{A}
\left[\begin{array}{c}
x_2 \\ x_2
\end{array}\right] = 5
$$</p>
<p>(Sıfır vektörü var çünkü $x_1^2,x_2^2$ içeren terimler var ama $x_1,x_2$
içeren terimler yok)</p>
<p>KKT matrisini şöyle oluştururuz, </p>
<p>$$
\left[\begin{array}{ccc}
Q &amp; A^T \\ A &amp; 0
\end{array}\right]
\left[\begin{array}{c}
x \\ u
\end{array}\right] =
\left[\begin{array}{r}
-c \\ b
\end{array}\right] 
$$</p>
<p>$$
\left[\begin{array}{ccc}
2 &amp; 0 &amp; 1 \\
0 &amp; 2 &amp; 1 \\
1 &amp; 1 &amp; 0
\end{array}\right]
\cdot
\left[\begin{array}{c}
x_1 \\ x_2 \\ u
\end{array}\right] = 
\left[\begin{array}{c}
0 \\ 0 \\ 5
\end{array}\right] 
$$</p>
<pre><code class="python">import numpy.linalg as lin
X = np.array([[2,0,1],[0,2,1],[1,1,0]]) 
a = np.array([[0],[0],[5]])
print (lin.solve(X,a))
</code></pre>

<pre><code>[[ 2.5]
 [ 2.5]
 [-5. ]]
</code></pre>

<p>Doğrulamak için paket ile çözelim,</p>
<pre><code class="python">from cvxopt import matrix
from cvxopt import solvers
Q = matrix([ [2.0, 0], [0, 2.0] ])
p = matrix([0.0, 0.0])
G = matrix([[0.0,0.0],[0.0,0.0]])
h = matrix([0.0,0.0])
A = matrix([1.0, 1.0], (1,2))
b = matrix(5.0)
sol=solvers.qp(Q, p, G, h, A, b)
print (sol['x'])
</code></pre>

<pre><code>     pcost       dcost       gap    pres   dres
 0:  1.2500e+01  1.2500e+01  2e+00  1e+00  1e-15
 1:  1.2500e+01  1.2500e+01  2e-02  1e-02  0e+00
 2:  1.2500e+01  1.2500e+01  2e-04  1e-04  0e+00
 3:  1.2500e+01  1.2500e+01  2e-06  1e-06  0e+00
 4:  1.2500e+01  1.2500e+01  2e-08  1e-08  0e+00
Optimal solution found.
[ 2.50e+00]
[ 2.50e+00]
</code></pre>

<p>Ekler</p>
<p>Soru</p>
<p>Eğer KKT şartını eşitlik sınırlanmış QP (bilahere LP) çözmek için
kullanabiliyorsam, ve mesela LP diyelim, her eşitsizlik içeren problemi
standardizasyon ile eşitlikle sınırlı probleme çevirebiliyorsam, KKT
matrisi ile her türlü LP'yi çözemez miyim? Niye farklı metotlara giriş
yapmak gerekiyor? </p>
<p>Cevap</p>
<p>Standardizasyon sonrası hala elimizde pozitiflik sınırlamaları var, ki
bunlar da birer eşitsizlik sınırı aslında. KKT matrisi çözmek bu
eşitsizlikleri tatmin etmez, basit bir matris tersi alıyoruz, elimize geçen
değişkenlerin pozitif kalma zorunluluğunu bu metot ile zorlayamayız.</p>
<p>Kaynaklar</p>
<p>[1] Tibshirani, <em>Convex Optimization, Lecture Video 12</em>, 
<a href="https://www.youtube.com/channel/UCIvaLZcfz3ikJ1cD-zMpIXg">https://www.youtube.com/channel/UCIvaLZcfz3ikJ1cD-zMpIXg</a>   </p>
<p>[2] Lendek, <em>Optimization Lecture, Quadratic Programming</em>
<a href="http://www.lendek.net/teaching/opt_en/">http://www.lendek.net/teaching/opt_en/</a></p>