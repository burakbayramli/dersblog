
<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [["$","$"]]}
      });
    MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
      MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
        cancel: ["Extension","cancel"],
        bcancel: ["Extension","cancel"],
        xcancel: ["Extension","cancel"],
        cancelto: ["Extension","cancel"]
      });
    });
    </script>
   <script type="text/javascript"
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_HTML-full">
   </script>
   <link rel="stylesheet" type="text/css" media="screen" href="https://burakbayramli.github.io/css/style.css">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1548953794786292"
          crossorigin="anonymous"></script>  
  </head>
    <body>
      <div id="header_wrap" class="outer">
        <header class="inner">
          <h1 id="project_title">
            <a href="https://burakbayramli.github.io" style="text-decoration:none; color:inherit;">dersblog</a>
          </h1>
          <h2 id="project_tagline"></h2>          
        </header>
      </div>
      <div id="main_content_wrap" class="outer">        
        <section id="main_content" class="inner">
        <h1></h1>
<h1>OSM Haritaları, PBF Dosyaları, En Kısa Yol, Djikstra</h1>

<p>Eğer yollar ağını içeren OSM haritasını kendimiz işleyip çıktı
dosyalarını rahat okunabilir düz CSV formatında tutmak istersek bu
mümkündür. Sonuçta OSM dosyaları [1] sitesinde bedava paylaşılıyor, ve
bahsedilen işlemi yapabilecek bir kod Rust [5] ile yazılmış
<code>osm4routing</code> kodudur. Amacımız iki nokta arasında bir kısa yol
algoritması yazmak olacak.</p>

<p><code>osm4routing</code> kurmak için</p>

<pre><code>cargo install osm4routing
</code></pre>

<p>Örnek olarak Şeysel (Seychelles) adalarına bakalım, ufak bir dosya
olduğu için örnekleri göstermek işletmek hızlı olur. Haritası Afrika
dizini altında, oradaki osm.pbf dosyası indirilir.  <code>$HOME/Downloads</code>
altında olduğunu farzedelim,</p>

<pre><code>osm4routing $HOME/Downloads/seychelles-latest.osm.pbf
</code></pre>

<p>Program oldukça hızlı işler, bitince iki tane dosya, <code>edges.csv</code> ve
<code>nodes.csv</code> üretilmiş olmalı. İçeriklerine bakalım (ilk birkaç satır),</p>

<div class="codehilite">
<pre><span></span><code><span class="err">!</span> <span class="n">head</span> <span class="o">-</span><span class="mi">10</span> <span class="n">nodes</span><span class="o">.</span><span class="n">csv</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>id,lon,lat
5766693114,55.2028362,-3.7270749
2737905006,55.694301599999996,-4.3259219
2710742974,55.4645328,-4.6004604
6808483052,55.462411599999996,-4.632185799999999
8979383052,55.518222699999995,-4.716342399999999
9144642426,55.4628521,-4.5883534
6407473046,55.4584707,-4.6071178999999995
8979071049,55.4408661,-4.624990299999999
3789265673,55.401677899999996,-4.6558733
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="err">!</span> <span class="n">head</span> <span class="o">-</span><span class="mi">3</span> <span class="n">edges</span><span class="o">.</span><span class="n">csv</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>id,osm_id,source,target,length,foot,car_forward,car_backward,bike_forward,bike_backward,train,wkt
26771422-0,26771422,293645412,1159221829,113.98597980501721,Allowed,Secondary,Secondary,Allowed,Allowed,Forbidden,&quot;LINESTRING(55.7601390 -4.3462977, 55.7602171 -4.3463866, 55.7602852 -4.3464620, 55.7603906 -4.3466138, 55.7604949 -4.3467581, 55.7605343 -4.3468123, 55.7605801 -4.3468621, 55.7606248 -4.3468929, 55.7606791 -4.3469152, 55.7607355 -4.3469237, 55.7608292 -4.3469269, 55.7608735 -4.3469255)&quot;
26771422-1,26771422,1159221829,2330448860,71.52456370873085,Allowed,Secondary,Secondary,Allowed,Allowed,Forbidden,&quot;LINESTRING(55.7608735 -4.3469255, 55.7613600 -4.3469271, 55.7614284 -4.3469290, 55.7614753 -4.3469333, 55.7615168 -4.3469417)&quot;
</code></pre>
</div>

<p>Çizit (graph) teorisi açısından bakarsak üstte veri bir ağ / çizit
yapısı var, ilk dosyadakiler düğümler (nodes) ikincidekiler ise
kenarlar (edges). Düğümler yeryüzünde bazı noktalar, bir durak
olabilir, yol ağzı olabilir, ya da yol üzerindeki bir nokta. Her
düğümün bir <code>id</code> kimliği var, ve bu <code>id</code> ile o noktanın kordinat
değerlerine enlem boylam üzerinden erişebiliyoruz. Kenarlar bir düğümü
bir diğerine bağlayan yollar gibi görülebilir, bağlantı parçaları. Her
kenarın da bir kimliği var, ve ayrıca çıkış noktası <code>source</code> bitiş
noktası <code>target</code> bilgisini taşıyor. Bu iki kolon tabii ki düğüm
verisindeki <code>id</code> değerlerine tekabül ediyor, kenar bir düğümden çıkıp
diğerinde bitiyor.</p>

<p>Kenarların, yani yolların taşıdığı bazı ek önemli bilgiler var; mesela
bir yolun yürümeye elverişli olup olmadığı (<code>foot</code> kolonunda <code>Allowed</code>
değeri var ise), aynı şekilde araba, bisiklet kullanımına uygun olup
olmadığı yol bilgisi içinde mevcut. </p>

<h3>Düğüm Veri Yapısı, Yakın Nokta Bulmak</h3>

<p>Kısa yol algoritması işletmek için bize neler lazım? Yol tarifi isterken bir
başlangıç ve bitiş noktası enlem/boylam olarak verilir, bu iki noktanın
OSM düğüm noktalarına eşlenmesi gerekiyor, aynen [3] yazısında olduğu gibi
önce verilen kordinatlara en yakın OSM noktası bulunur, ve oradan sonra
düğüm, kenar, sonraki düğüm vs diye yol arama algoritması işleyebilir.</p>

<p>Fakat "en yakın nokta bulmak" performans açısından o kadar kolay bir
iş değil; örnek olarak burada ufak veri kullandık ama mesela TR
boyutunda bir haritada milyonlarca nokta ve onların arasında bağlantı
olacaktır. Milyonlarca satır içinden en yakın olanını bulmak eğer tüm
verilere teker teker bakılıyorsa uzun sürebilir. Bize bir tür
indeksleme (indexing) mekanizması gerekiyor.</p>

<p>İlk akla gelebilecek çözümler QuadTree, KDTree gibi seçenekler, fakat
bu çözümlerin çoğu bellek bazlı işler; etrafta bulunabilecek mevcut
kodlar milyonlarca veri noktasını alıp bir indislenmiş ağaç yapısı
oluşturabilir ama bunu veri yapısını hafıza tuturak yapar. İdeal
olarak nokta bulmak, kısa yol hesaplama algoritmasının ufak bilgisayar
üzerinde işleyebilmesi tercihimiz (bir ağaç yapısını hafızaya diskten
geri aldığımızda gigabayt seviyesinde olmamalı). Eğer ağır işlem
bedeli ödenecekse onun baştan, veri hazırlığı evresinde ödenmesi daha
iyi olacaktır.</p>

<p>Şöyle bir çözüm olabilir, harita üzerinde bir izgara oluştururum, 4 x
4, ya da 3 x 4 boyutunda olabilir, bu bana 12 izgara noktası verir,
sonra veriyi baştan sonra işlerken elimdeki her düğüm için onun en
yakın olduğu iki izgara noktasını bulurum ve yeni bir tabanda
kaydederim. Bu yeni dosyayı bir SQL tabanına yazarım, her satırda
yakın izgara noktaları mesela kolonlar <code>ç1</code> ve <code>c2</code> olabilir ve yeni
tabloyu bu kolonlar bazlı indekslerim, böylece <code>c1</code> ve <code>c2</code> bazlı
filtreleme işlemi hızlanır.</p>

<p>Izgara noktalarını bir pickle içinde kaydederim, böylece sonradan
isteyen yükleyebilir, ve artık herhangi bir nokta için aynı izgara
yakınlığı işletilir, mesela <code>c1=3</code>, <code>c2=5</code> bulundu diyelim ve SQL
tabanından ya 3 ya da 5 değerine sahip olan düğümleri <code>SELECT</code> ile
alırım, ve bu noktalar üzerinde detaylı yakınlık hesabı
işletirim. Böylece gerçek mesafe hesabı yapacağım veri miktarını
azaltmış oldum.  Bu mantıklı olmalı, haritayı bölgelere ayırmış oldum,
eğer elimde Karadeniz bölgesinden bir nokta varsa Akdeniz bölgesindeki
noktalara bakmaya ne gerek var?</p>

<p>Burada seçilen teknolojilerin özelliklerine, kuvvetlerine dikkat;
ızgara noktası bazlı filtreleme için SQL kullandık çünkü tam sayı
bazlı filtreleme işlerini hem disk bazlı (herşeyi hafızaya almadan) ve
çok hızlı yapar. Izgara ataması yaparken <code>nodes.csv</code> satır satır
işlenecek, ve o sırada satır satır SQL tabanına yazım yapılacak, bu da
hızlı, mesafe hesabı yapılıyor ama sadece 12 ızgara noktası için
yapıldığı için çok performans kaybı yok.</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">csv</span><span class="o">,</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">pickle</span><span class="o">,</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">pygeodesy.sphericalNvector</span> <span class="kn">import</span> <span class="n">LatLon</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">dbfile</span> <span class="o">=</span> <span class="s2">&quot;nodes.db&quot;</span>

<span class="k">def</span> <span class="nf">grid_assign_centers</span><span class="p">(</span><span class="n">corner1</span><span class="p">,</span><span class="n">corner2</span><span class="p">):</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">LatLon</span><span class="p">(</span><span class="n">corner1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">corner1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">LatLon</span><span class="p">(</span><span class="n">corner2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">corner2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">lowlat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">p1</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="n">p2</span><span class="o">.</span><span class="n">lat</span><span class="p">])</span>
    <span class="n">lowlon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">p1</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span><span class="n">p2</span><span class="o">.</span><span class="n">lon</span><span class="p">])</span>
    <span class="n">hilat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">p1</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span><span class="n">p2</span><span class="o">.</span><span class="n">lat</span><span class="p">])</span>
    <span class="n">hilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">p1</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span><span class="n">p2</span><span class="o">.</span><span class="n">lon</span><span class="p">])</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lowlon</span><span class="p">,</span><span class="n">hilon</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lowlat</span><span class="p">,</span><span class="n">hilat</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">mids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
        <span class="n">mids</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span>       
    <span class="n">mids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mids</span><span class="p">)</span>

    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">mids</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;centers.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>        

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbfile</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>    
    <span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE osm_nodes(id INTEGER PRIMARY KEY, </span>
<span class="s1">                      lat NUMERIC, lon NUMERIC, c1 INTEGER, c2 INTEGER)</span>
<span class="s1">                      &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;nodes.csv&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">rd</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">rd</span><span class="p">))}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rd</span><span class="p">):</span>        
            <span class="nb">id</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]],</span><span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]],</span><span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]]</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">mids</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">]]))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;INSERT INTO osm_nodes(id, lat, lon, c1, c2)</span>
<span class="s1">                      VALUES(?,?,?,?,?)&#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">lat</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span><span class="n">lon</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>            
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;satir&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;CREATE INDEX index1 ON osm_nodes(c1)&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;CREATE INDEX index2 ON osm_nodes(c2)&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="c1"># iki tane kose noktasini haritadan elle sectik</span>
<span class="n">grid_assign_centers</span><span class="p">((</span><span class="o">-</span><span class="mf">4.807419070202981</span><span class="p">,</span> <span class="mf">55.364345234773644</span><span class="p">),</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">4.549969190633921</span><span class="p">,</span> <span class="mf">55.566362543604434</span><span class="p">))</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>satir 0
satir 1000
satir 2000
satir 3000
satir 4000
satir 5000
satir 6000
</code></pre>
</div>

<p>Tablo <code>osm_nodes</code> yaratıldı. Dikkat, indeksler tüm satırlar eklendikten
<em>sonra</em> yaratıldı. Eğer tablo yaratıldığında indeksleri yaratmış olsak
bu <code>INSERT</code> işlemlerini yavaşlatırdı. </p>

<p>Seçilen köşe ve hesaplanan ızgara noktaları altta grafikleniyor,</p>

<p><img width='300' src='osm1.jpg'/> </p>

<p>Şimdi bu ızgara noktalarını kullanarak bize "kordinata en yakın olan
OSM id'sini bul" mantığını kodlayabiliriz.</p>

<div class="codehilite">
<pre><span></span><code><span class="k">def</span> <span class="nf">find_closest_node</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">):</span>
    <span class="n">mids</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;centers.pkl&quot;</span><span class="p">,</span><span class="s2">&quot;rb&quot;</span><span class="p">))</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>

    <span class="n">frvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">mids</span><span class="p">,</span><span class="n">frvec</span><span class="p">)</span>
    <span class="n">fr_closest_mid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">frres</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select id,lat,lon from osm_nodes where c1==? or c1==? or c2==? or c2==?&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,(</span><span class="nb">int</span><span class="p">(</span><span class="n">fr_closest_mid</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                          <span class="nb">int</span><span class="p">(</span><span class="n">fr_closest_mid</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                          <span class="nb">int</span><span class="p">(</span><span class="n">fr_closest_mid</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                          <span class="nb">int</span><span class="p">(</span><span class="n">fr_closest_mid</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span> <span class="n">frres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">frres</span><span class="p">);</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>

    <span class="n">frres</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">]],</span> <span class="n">frvec</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">frres</span><span class="p">)][[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</code></pre>
</div>

<p>Altta iki nokta seçtik, bunları birazdan yol hesabı için başlangıç
bitiş noktaları olarak kullanacağız, </p>

<div class="codehilite">
<pre><span></span><code><span class="n">fr</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">4.699287820423064</span><span class="p">,</span> <span class="mf">55.49185927728346</span><span class="p">)</span>
<span class="n">to</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">4.6364140603708925</span><span class="p">,</span> <span class="mf">55.406975784999176</span><span class="p">)</span>

<span class="n">find_closest_node</span><span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>Out[1]: [5241652028.0, -4.70279, 55.48997]
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">find_closest_node</span><span class="p">(</span><span class="n">to</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">to</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>Out[1]: [8059195265.0, -4.63801, 55.40781]
</code></pre>
</div>

<p>Bu noktalar hakikaten de benim seçtiğim yerlere yakın. Demek ki
listedeki ilk sayı, OSM kimliğini kullanabilirim.</p>

<h3>Bağlantılar</h3>

<p>İkinci teknoloji seçimine gelelim, bu bir önceki konu kadar önemli,
yolları temsil eden çiziti, yani düğümler ve aralarındaki bağlantıları
nasıl temsil edeceğiz? Bu seçimi yaparken aklımda bazı tercihler ve
bilgiler var. Mesela [7] yazısında anlatılan kısa yol algoritmasının
Python sözlüğü bazlı çalıştığını biliyorum, çiziti bir "sözlük içinde
sözlük" yapısında olmasını bekliyor, yani çizit <code>G</code> ise mesela
<code>G['a']</code> ile <code>G</code> sözlüğünden ikinci bir sözlük elde ediyoruz, bu
sözlükte hedef düğümü geçiyoruz, bu bize yolun ağırlığını / uzaklığını
veriyor, mesela <code>G['a']['b']</code> ile <code>a</code> düğümünün <code>b</code> düğümüne
uzaklığını elde ediyorum. Bu elde var.</p>

<p>İkinci tercih daha önceki durumda olduğu gibi herşeyi hafızaya
almaktan kaçınmak. Mümkün olduğu kadar herşeyi disk bazlı yapmak.  Bu
bizi nihai teknoloji tercihine götürüyor - disk bazlı bir sözlük!
Daha önceki bir yazıda [6] bunu görmüştük, <code>diskdict</code>. O zaman kenar
verilerini bir <code>diskdict</code> sözlüğüne ekleyerek ikinci veri yapısını
elde edebilirim.</p>

<p>Algoritmayı yazalım, <code>edges.csv</code> dosyasını satır satır gezerken
her çıkış düğümü <code>source</code> ile bitiş noktası <code>target</code> arasında <code>length</code>
uzaklığını sözlük içindeki sözlüğe ekliyoruz.</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">from</span> <span class="nn">diskdict</span> <span class="kn">import</span> <span class="n">DiskDict</span>

<span class="n">dictdir</span> <span class="o">=</span> <span class="s2">&quot;walkdict&quot;</span>

<span class="k">def</span> <span class="nf">diskdict</span><span class="p">():</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dictdir</span><span class="p">):</span> <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dictdir</span><span class="p">)</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;bos hucreleri yarat&#39;</span><span class="p">)</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="n">DiskDict</span><span class="p">(</span><span class="n">dictdir</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;edges.csv&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">rd</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">rd</span><span class="p">))}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rd</span><span class="p">):</span>        
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;satir&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;foot&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;Allowed&#39;</span><span class="p">:</span>
                <span class="n">dd</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">dd</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">dd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;baglantilari ekle&#39;</span><span class="p">)</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="n">DiskDict</span><span class="p">(</span><span class="n">dictdir</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;edges.csv&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">rd</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">rd</span><span class="p">))}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rd</span><span class="p">):</span>        
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;satir&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;foot&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;Allowed&#39;</span><span class="p">:</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]]]</span>
                <span class="n">tmp</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]]</span>
                <span class="n">dd</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">tmp</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]]]</span>
                <span class="n">tmp</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]]</span>
                <span class="n">dd</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">tmp</span>

    <span class="n">dd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">diskdict</span><span class="p">()</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>bos hucreleri yarat
satir 0
satir 1000
satir 2000
satir 3000
satir 4000
satir 5000
satir 6000
satir 7000
baglantilari ekle
satir 0
satir 1000
satir 2000
satir 3000
satir 4000
satir 5000
satir 6000
satir 7000
</code></pre>
</div>

<p>Oldu mu acaba?</p>

<p><img src="osm2.jpg" alt="" /></p>

<p>[devam edecek]</p>

<p>Kaynaklar</p>

<p>[1] http://download.geofabrik.de/index.html</p>

<p>[2] ../../2016/11/yol-tarifi-harita-bilgisi-osrm-backend.html</p>

<p>[3] ../../2023/04/yol-bolmak-osm-osmnx.html</p>

<p>[4] https://github.com/Tristramg/osm4routing2</p>

<p>[5] <a href="../../2023/01/rust.html">Rust</a></p>

<p>[6] <a href="../../2023/05/python-sozluk-dictionary.html">Python Sözlük (Dictionary) Veri Yapısı</a></p>

<p>[7] <a href="https://burakbayramli.github.io/dersblog/algs/algs_035_dijks/dijkstra_algoritmasi_ile_en_kisa_yol.html">Dijkstra Algoritması ile En Kısa Yol</a></p>

<p>[8] <a href="https://www.ics.uci.edu/~eppstein/161/python/">University of California Bilgisayar Bilim Kodları</a></p>

          <br/><a href="../index.html">Yukarı</a>
        </section>          
      </div>
    </body>
</html>
