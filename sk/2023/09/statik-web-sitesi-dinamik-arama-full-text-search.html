
<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [["$","$"]]}
      });
    MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
      MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
        cancel: ["Extension","cancel"],
        bcancel: ["Extension","cancel"],
        xcancel: ["Extension","cancel"],
        cancelto: ["Extension","cancel"]
      });
    });
    </script>
   <script type="text/javascript"
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_HTML-full">
   </script>
   <link rel="stylesheet" type="text/css" media="screen" href="https://burakbayramli.github.io/css/style.css">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1548953794786292"
          crossorigin="anonymous"></script>  
  </head>
    <body>
      <div id="header_wrap" class="outer">
        <header class="inner">
          <h1 id="project_title">
            <a href="https://burakbayramli.github.io" style="text-decoration:none; color:inherit;">dersblog</a>
          </h1>
          <h2 id="project_tagline"></h2>          
        </header>
      </div>
      <div id="main_content_wrap" class="outer">        
        <section id="main_content" class="inner">
        <h1></h1>
<h1>Statik Sitelerde Dinamik Kelime Arama Sistemi</h1>

<p>Dinamik Web siteleri bilindiği gibi üç katmana sahiptir, istemci /
müşteri tarayıcı ile bağlanır, buradan gelen istekle (requests) servis
tarafında karşılanır, servis tarafındaki kodlar işlem mantığı
koşturur, bir veri tabanına bağlanıp veri alışveri yapabilir, ve
sonuçta sayfa üretilir, ve kullanıcıya gösterilir. Tarayıcı içinde de
müşteri odaklı ek kodlar işletilebiliyor, bu kodlar sayfa ile beraber
bağlanana gönderilir, Javascript dilindeki bu kodlar prezentasyon
üzerinde ek işlemler yapabilir, bir sürü görsel işlem Javascript ile
mümkün, hatta bir süredir Ajax ile serviste direk fonksiyon çağrısı
bile yapılabiliyor.</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">unidecode</span> <span class="kn">import</span> <span class="n">unidecode</span>
<span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">glob</span>

<span class="n">WORD</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">punc_list</span> <span class="o">=</span> <span class="s1">&#39;!&quot;#$%^()*+,-./:;&lt;=&gt;?@[\]^_{|}~&#39;</span> <span class="o">+</span> <span class="s1">&#39;0123456789&#39;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">maketrans</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">punc_list</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">maketrans</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="s2">&quot;&#39;`&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span>

<span class="k">def</span> <span class="nf">reg_tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">WORD</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">words</span>

<span class="n">invidx</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
<span class="nb">dir</span> <span class="o">=</span> <span class="s2">&quot;[DIR]&quot;</span>

<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">dir</span> <span class="o">+</span> <span class="s2">&quot;/**/**/*.md&quot;</span><span class="p">)</span>
<span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>    
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">reg_tokenize</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">()):</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">unidecode</span><span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">invidx</span><span class="p">[</span><span class="n">word</span><span class="p">][</span><span class="n">doc</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span> <span class="p">(</span><span class="n">doc</span><span class="p">)</span>

<span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;data/invidx.json&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
<span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">invidx</span><span class="p">))</span>
<span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">invidx</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;data/invidx.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">invidx_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span>  <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">:</span>
    <span class="n">invidx_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">invidx</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">first_letter</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">first_letter</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">:</span>
        <span class="n">invidx_dict</span><span class="p">[</span><span class="n">first_letter</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">invidx_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;data/invidx-</span><span class="si">%s</span><span class="s2">.json&quot;</span> <span class="o">%</span> <span class="n">k</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="c1">#points = [0, 12, 9]</span>
<span class="c1">#res = sorted(range(len(points)), key=lambda x: points[x])</span>
<span class="c1">#print(res)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="c1">#a = [1, 2, 3, 4]; b = [2, 3, 4, 5]; c = [3, 4, 5, 6]; d = [4, 1, 3, 9]</span>
<span class="c1">#u = set.intersection(set(a),set(b),set(c),set(d))</span>
<span class="c1">#print (u)</span>

<span class="n">search</span> <span class="o">=</span> <span class="s2">&quot;green ammonia&quot;</span>

<span class="n">stok</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="n">stok_hits</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">stok</span><span class="p">:</span>
    <span class="n">stok_hits</span><span class="p">[</span><span class="n">tok</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;data/invidx-</span><span class="si">%s</span><span class="s2">.json&quot;</span> <span class="o">%</span> <span class="n">tok</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">())[</span><span class="n">tok</span><span class="p">]</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">stok_hits</span><span class="p">[</span><span class="n">tok</span><span class="p">]))</span>

<span class="n">u</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)</span>

<span class="n">hits</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">u</span><span class="p">:</span>
    <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="p">,</span><span class="nb">sum</span><span class="p">([</span><span class="n">stok_hits</span><span class="p">[</span><span class="n">tok</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">stok</span><span class="p">])])</span>

<span class="n">sorted_hits</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">hits</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="nb">print</span> <span class="p">(</span><span class="n">hits</span><span class="p">[</span><span class="n">sorted_hits</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">defer</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;pyscript.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>    
      <span class="p">&lt;</span><span class="nt">py-script</span><span class="p">&gt;</span>
        from pyodide.http import open_url
        from collections import defaultdict
        import json

        search = &quot;green ammonia&quot;

        stok = search.split()

        stok_hits = {}

        results = []

        for tok in stok:
           url = &#39;http://192.168.43.49:5000/static/invidx-%s.json&#39; % tok[0]
           df = open_url(url)        
           stok_hits[tok] = json.loads(df.getvalue())[tok]
           results.append(set(stok_hits[tok]))


        u = set.intersection(*results)

        hits = []

        for f in u:
           hits.append([f,sum([stok_hits[tok][f] for tok in stok])])

        sorted_hits = sorted(range(len(hits)), key=lambda x: hits[x][1], reverse=True)

        for i in range(20):
           display (hits[sorted_hits[i]])

      <span class="p">&lt;/</span><span class="nt">py-script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;output&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">py-script</span><span class="p">&gt;</span>
  def write_to_page():
     manual_div = Element(&quot;output&quot;)
     inp = Element(&quot;search&quot;)
     manual_div.element.innerText = inp.element.value
<span class="p">&lt;/</span><span class="nt">py-script</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
 <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;search&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;search&quot;</span><span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">button</span> <span class="na">py-click</span><span class="o">=</span><span class="s">&quot;write_to_page()&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;manual&quot;</span><span class="p">&gt;</span>Search<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</code></pre>
</div>

<p>[devam edecek]</p>

          <br/><a href="../index.html">Yukarı</a>
        </section>          
      </div>
    </body>
</html>
