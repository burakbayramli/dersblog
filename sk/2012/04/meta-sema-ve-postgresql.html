<h1>Meta, Sema ve Postgresql</h1>
<p>Meta, Sema ve Postgresql</p>
<p>Tablolar hakkinda sema, meta bilgisi almak istiyorsaniz, ve pg_dump komutu problem cikartiyorsa, tablo, kolon, tip bilgisi icin</p>
<p>select column_name,udt_name from information_schema.columns where table_name = '[tablo]'  order by ordinal_position</p>
<p>gibi bir sorgu gerekli bilgiyi alir. Siralamayi ordinal_position uzerinden yapmamiz iyi olur, cunku bu siralama o tablo uzerinde "select *" islettigimizde kolonlarin gelecegi sira. Tabandan veri cekerken genellikle (basitlik amaciyla) select * kullanildigi icin semanin da ayni siralamaya uyacak sekilde alinmasi iyi olur.</p>
<p>Not: information_schema.columns uzerinde baska ilginc kolonlar da var.</p>
<p>Eger indis bilgisi almak istiyorsak,</p>
<p>SELECT tablename, indexdef FROM pg_catalog.pg_indexes</p>
<p>Bu sorgu indisi uretmek icin gerekli komutu bile gosterecektir.</p>
<p>Otomatik olarak uzaktaki bir semayi verisiyle indisleriyle beraber yerel bir tabana aktarmak icin su script'ler kullanilabilir. </p>
<p>run_csv.sh - uzaktaki makina uzerinde sql isletip ciktiyi bir csv olarak kaydeder,</p>
<p>psql [.. uzaktaki makina .. ] -c "COPY ($1) TO stdout with delimiter ',' CSV HEADER "</p>
<p>run.sh - yerel taban uzerinde argumanda verilen sql dosyasini isletir</p>
<p>psql [.. yerel ..]  &lt; $1</p>
<p>csv_schema.py - sema ciktisini alip sql komutlarina donusturur</p>
<p>import csv, sys# argv 1: csv file name# argv 2: table nameschema = csv.reader(open(sys.argv[1], 'rb'), delimiter=',')schema.next() # skip headerprint "drop TABLE if exists %s ;" % sys.argv[2]print "CREATE TABLE %s (" % sys.argv[2]i = 0list = list(schema)l = len(list)-1for line in list:    if i &lt; l:        print "%s %s, " % (line[0], line[1])    else:        print "%s %s " % (line[0], line[1])    i+=1print ");\n"</p>
<p>schema.sh - python script'i kullanarak semayi doker, ve yerel tablo uzerinde isletir. </p>
<p>sh run_csv.sh "select column_name,udt_name from information_schema.columns where table_name = '[tablo]'" &gt; $LH_DATA_DIR/$1/[tablo].outpython csv_schema.py DATA_DIR/$1/[tablo].out [tablo] &gt; $LH_DATA_DIR/$1/[tablo].sqlsh run.sh DATA_DIR/$1/[tablo].sql</p>
<p>dump.sh - tablolarin verisini db dosyalarina kaydeder</p>
<p>sh run_csv.sh "select * from [tablo]" &gt; DATA_DIR/$1/[tablo].db</p>
<p>load.sh - db dosyalarini yerel tabloya yukler</p>
<p>psql [..yerel..] -c "COPY [tablo] FROM 'DATA_DIR/$1/[tablo].db' with csv header delimiter ',' ";</p>
<p>indexes.sh - indeksleri uzaktaki makinadan alarak yerelde isletir</p>
<p>sh run_csv.sh "SELECT indexdef FROM pg_catalog.pg_indexes where tablename = '[tablo]' " &gt; /tmp/idx
perl -pi -e 's/\"//sg' /tmp/idx
perl -pi -e 's/\n/;\n/sg' /tmp/idx
tail -n+2 /tmp/idx &gt; $LH_DATA_DIR/$1/[tablo]_idx.sql
sh run.sh $LH_DATA_DIR/$1/[tablo]_idx.sql</p>