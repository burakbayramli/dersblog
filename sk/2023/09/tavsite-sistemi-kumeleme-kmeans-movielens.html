
<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [["$","$"]]}
      });
    MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
      MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
        cancel: ["Extension","cancel"],
        bcancel: ["Extension","cancel"],
        xcancel: ["Extension","cancel"],
        cancelto: ["Extension","cancel"]
      });
    });
    </script>
   <script type="text/javascript"
       src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_HTML-full">
   </script>
   <script async="async" data-cfasync="false" src="//pl22489825.profitablegatecpm.com/d84f574876e65b2d8f0c7bae784c22b3/invoke.js"></script>
      <div id="container-d84f574876e65b2d8f0c7bae784c22b3"></div>   

   <link rel="stylesheet" type="text/css" media="screen" href="https://burakbayramli.github.io/css/style.css">
  </head>
    <body>
      <div id="header_wrap" class="outer">
        <header class="inner">
          <h1 id="project_title">
            <a href="https://burakbayramli.github.io" style="text-decoration:none; color:inherit;">dersblog</a>
          </h1>
          <h2 id="project_tagline"></h2>          
        </header>
      </div>
      <div id="main_content_wrap" class="outer">        
        <section id="main_content" class="inner">
        <h1></h1>
<h1>Kümeleme (Clustering) ile Tavsiye Sistemi</h1>

<p>Tavsiye sistemlerini kodlamanın klasik yolu kullanıcı-ürün matrisinde
(ki matris ögeleri beğeni notunu taşır) arama yapmaktır. Kendi
beğenilerim bu matris dışında ona benzer ama ayrı bir satır olarak
düşünülebilir, bu satırın tüm kullanıcılara olan mesafesini [2]
hesaplarım, bana en yakın kullanıcıları bulurum, ve onların en
beğendiği ürünleri tavsiye alırım.</p>

<p>Bu teknik tüm matrisi tarar, onun tüm satırlarına bakar. Beğeni
matrisi seyrektir tabii ki bu aramayı hızlandırır fakat yine de
tavsiye sistemi tüm veriye sahip olmalıdır. </p>

<p>Bir diğer yöntem kullanıcı satırlarını kümelere ayırarak beğenileri
birbirine benzeyen kişileri aynı grup altında toplamak. Böylece her
küme için onu temsil eden bir küme merkezi vektörü elde edebiliriz, ve
yeni kullanıcının bu merkezlere olan mesafesini hesaplarız sadece,
10-20 tane küme için, ve sonra kümedeki kullanıcıları listeleyip
onların beğenilerini tavsiye olarak veririz.</p>

<p>Örnek veri [1] sitesinden, oradaki <code>ml-latest-small.zip</code> verisini
alacağız.  Daha büyük bir veri seti <code>ml-25m.zip</code> içinde. Veride bazı
önişlemler hala lazım, veri setinde <code>ratings.csv</code> dosyası mesela şu
formatta,</p>

<pre><code>userId,movieId,rating,timestamp
1,296,5.0,1147880044
1,306,3.5,1147868817
1,307,5.0,1147868828
1,665,5.0,1147878820
</code></pre>

<p>Aynı kullanıcı kimliği birden fazla farklı satıra dağılmış
halde. Satır satır işleme bazlı yapan yaklaşımlar için bir
kullanıcının tüm verisini aynı satırda almak daha iyidir, böylece azar
azar (incremental) işlem birimi kullanıcı olur, tek satır okuyunca tek
bir kullanıcı işlemiş oluruz. Ayrıca parallel işlem gerektiğinde aynı
kullanıcı veisinin farklı süreçlere dağıtılması gerekmez, bunun
kordinasyonu zor olurdu. O zaman üstteki veriyi kullanıcı bazlı hale
getirelim, ayrıca verinin seyrekliğini gözönünde bulundurursak, not
verilen filmleri sözlük öğesi yapalım. Sözlük, metin formatta JSON
olarak tutulabilir, dosyaya böyle yazılır.  Yeni veride iki kolon
olacak, birincisi <code>userId</code>, ikincisi ise bir JSON metni. Değişimi
yapalım,</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">csv</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">os</span>

<span class="n">indir</span> <span class="o">=</span> <span class="s2">&quot;/opt/Downloads/ml-latest-small&quot;</span>
<span class="n">outdir</span> <span class="o">=</span> <span class="s2">&quot;/tmp/movie&quot;</span>
<span class="n">infile</span> <span class="o">=</span> <span class="n">indir</span> <span class="o">+</span> <span class="s2">&quot;/ratings.csv&quot;</span>
<span class="n">outfile</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;/ratings-json.csv&quot;</span>
<span class="n">curruser</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">row_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

<span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>   
    <span class="n">rd</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">rd</span><span class="p">))}</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rd</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]]</span> <span class="o">!=</span> <span class="n">curruser</span><span class="p">:</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">curruser</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">row_dict</span><span class="p">))</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">curruser</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]]</span>
            <span class="n">row_dict</span> <span class="o">=</span> <span class="p">{}</span>       
        <span class="n">row_dict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;movieId&#39;</span><span class="p">]])]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]])</span>
<span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">show_out</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">):</span>
    <span class="n">fin</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fin</span><span class="o">.</span><span class="n">readlines</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="n">n</span> <span class="ow">and</span> <span class="n">i</span><span class="o">&lt;=</span> <span class="n">m</span><span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="n">line</span><span class="p">[:</span><span class="mi">30</span><span class="p">],</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="n">m</span><span class="p">:</span> <span class="k">break</span>

<span class="k">def</span> <span class="nf">ls</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
   <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;/bin/ls -s1 &quot;</span> <span class="o">+</span> <span class="n">dirname</span>
   <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
   <span class="n">output</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
   <span class="n">res</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">)</span>
   <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span> <span class="nb">print</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>   
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">show_out</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>2|{&quot;318&quot;: 3.0, &quot;333&quot;: 4.0, &quot;17 ..
3|{&quot;31&quot;: 0.5, &quot;527&quot;: 0.5, &quot;647 ..
4|{&quot;21&quot;: 3.0, &quot;32&quot;: 2.0, &quot;45&quot;: ..
5|{&quot;1&quot;: 4.0, &quot;21&quot;: 4.0, &quot;34&quot;:  ..
6|{&quot;2&quot;: 4.0, &quot;3&quot;: 5.0, &quot;4&quot;: 3. ..
</code></pre>
</div>

<p>Kullanıcı <code>4</code> film <code>21</code> için 3 notunu vermiş.. böyle gidiyor.</p>

<h3>Kümeleme</h3>

<p>K-Means algoritmasının ana mantığı, paralel versiyonu [3,4]'te
işlendi.</p>

<p>Algoritmaya geçmeden önce bazı hazırlık işlemleri yapalım. Filmlerin tabandaki
kimlik no'ları matris üzerinde kullanıma hazır değil, onlara 0'dan başlayan bir
artarak giden kimliği biz atayacağız, ve aradaki eşlemeyi bir sözlük ile
yapacağız, sözlükler <code>movie_id_int.json</code> ve <code>movie_title_int.json</code> içinde
olacak. </p>

<p>Ayrıca K-Means'te bir ilk fitilin yakılması, önyükleme (boostrap)
gerekir, çünkü algoritma verili etiketler üzerinden küme merkezleri,
verili küme merkezleri üzerinden etiket eşlemesi hesaplar, özyineli
bir algoritmadir, fakat ilk başlangıçta bu iki bilgide mevcut
değildir, bu durumda bir yerden başlanılması gerekir, çoğu yaklaşım
mesela küme merkezlerini rasgele atar. Bu örnekte küme merkezi yerine
etiket ataması (hangi kullanıcı hangi kümeye ait) rasgele yapılırsa
daha iyi, çünkü seyrek veri durumunda reel sayılar olan küme
merkezlerini iyi seçememek mümkün. Belli bir aralıktaki tam sayı küme
ataması daha basit, <code>cluster_ass</code> değişkeninde bu atama olacak.</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">K</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># kume sayisi</span>
<span class="n">M</span> <span class="o">=</span> <span class="mi">9742</span> <span class="c1"># film sayisi</span>
<span class="n">U</span> <span class="o">=</span> <span class="mi">610</span> <span class="c1"># kullanici sayisi</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">prepare</span><span class="p">():</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">indir</span> <span class="o">+</span> <span class="s2">&quot;/movies.csv&quot;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;movieId&#39;</span><span class="p">)[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;/movie_id_int.json&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">indir</span> <span class="o">+</span> <span class="s2">&quot;/movies.csv&quot;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;/movie_title_int.json&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">cluster_ass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">U</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/cluster-assignments-0&#39;</span><span class="p">,</span><span class="n">cluster_ass</span><span class="p">)</span>

<span class="n">prepare</span><span class="p">()</span>
</code></pre>
</div>

<p>Bu kodu işlettikten sonra gerekli başlangıç dosyaları <code>outdir</code> içinde
olmalı.  Şimdi işletimi sağlayacak yardımcı kodu paylaşalım, detaylar
[4] içinde bulunabilir, ileride paralel işletimi de sağlayacak,</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">hookobj</span><span class="p">):</span>
    <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">beg</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">file_size</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">end_chunk</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">beg</span><span class="p">,</span><span class="n">end_chunk</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">beg</span> <span class="o">=</span> <span class="n">end_chunk</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="n">hookobj</span><span class="o">.</span><span class="n">ci</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">hookobj</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">break</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">hookobj</span><span class="o">.</span><span class="n">post</span><span class="p">()</span>        
</code></pre>
</div>

<p>Artık işleyici kodları yazabiliriz. Bize iki tane ayrı kod bloğu
gerekiyor, bunlardan ilki daha önce söylediğimiz gibi verili küme
atamalarını kullanarak küme merkezlerini hesaplar. İkincisi küme
merkezlerini kullanarak kullanıcı küme atamalarını yapar. Atama verisi
basit tek bir vektör içinde, <code>U</code> tane kullanıcı (seyirci), <code>K</code> tane
küme var, o zaman <code>(1,M)</code> boyutunda, içeriği 0 ile <code>K</code> arasında bir
değer, ilk atamaların rasgele yapıldığı vektöre bakalım,</p>

<div class="codehilite">
<pre><span></span><code><span class="n">ca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;/cluster-assignments-0.npz&quot;</span><span class="p">)[</span><span class="s1">&#39;arr_0&#39;</span><span class="p">]</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;atamalar&#39;</span><span class="p">,</span><span class="n">ca</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">ca</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>atamalar (610,)
[4 0 3 3 3 1 3 2 4 0] ...
</code></pre>
</div>

<p>İkinci kod parçası atamaları kullanıp küme merkezlerini yaratır, bu
merkez bir küme içindeki seyircilerin tüm filmlere verdiği notların
ortalamasıdır, bu tüm kümeler için yapılır o zaman sonuç matrisinin
boyutu <code>K</code> küme <code>M</code> film için K x M olmalı. Her iki kod parçası
alttadır,</p>

<div class="codehilite">
<pre><span></span><code><span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">lin</span>
<span class="n">fin1</span>  <span class="o">=</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;/ratings-json.csv&quot;</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">KMeans1Job</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">iter_no</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_no</span> <span class="o">=</span> <span class="n">iter_no</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">movie_id_int</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;/movie_id_int.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_ass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;/cluster-assignments-</span><span class="si">%d</span><span class="s2">.npz&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_no</span><span class="o">-</span><span class="mi">1</span><span class="p">))[</span><span class="s1">&#39;arr_0&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,</span><span class="n">M</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,</span><span class="n">M</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">line</span><span class="p">):</span>
        <span class="nb">id</span><span class="p">,</span><span class="n">jsval</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
        <span class="n">ratings</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jsval</span><span class="p">)</span>
        <span class="n">my_k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_ass</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">mov</span><span class="p">,</span><span class="n">rating</span> <span class="ow">in</span> <span class="n">ratings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="n">my_k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">movie_id_int</span><span class="p">[</span><span class="n">mov</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">rating</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">my_k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">movie_id_int</span><span class="p">[</span><span class="n">mov</span><span class="p">]]</span> <span class="o">+=</span> <span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/means-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_no</span><span class="p">,</span> <span class="n">means</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;KMeans1Job tamam&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">KMeans2Job</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">iter_no</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ci</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_no</span> <span class="o">=</span> <span class="n">iter_no</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;/means-</span><span class="si">%d</span><span class="s2">.npz&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_no</span><span class="p">))[</span><span class="s1">&#39;arr_0&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">movie_id_int</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;/movie_id_int.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_ass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">U</span><span class="p">,))</span>


    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">line</span><span class="p">):</span>
        <span class="nb">id</span><span class="p">,</span><span class="n">jsval</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
        <span class="n">ratings</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jsval</span><span class="p">)</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mov</span><span class="p">,</span><span class="n">rating</span> <span class="ow">in</span> <span class="n">ratings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">vec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">movie_id_int</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">mov</span><span class="p">)]]</span> <span class="o">=</span> <span class="n">rating</span>
        <span class="n">nearest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">lin</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="n">vec</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">[:,</span><span class="n">vec</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_ass</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">nearest</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/cluster-assignments-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_no</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_ass</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;KMeans2Job tamam&#39;</span><span class="p">)</span>
</code></pre>
</div>

<p>Ortalamalar</p>

<p><code>KMeans1Job</code> kodunda ortalamalar için her küme için o küme altındaki
kullanıcıların notları, yani vektörler toplanır, aynı sırada kaç not
verilmiş olduğu takip edilir, ve toplam not sayısına bölünür. Sıfır
ile bölüm tehlikesi var muhakkak, bu durumda özel bir bölme çağrısı
kullanacağız, <code>numpy.divide</code>, bir örnek altta,</p>

<div class="codehilite">
<pre><span></span><code><span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,))</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,))</span>

<span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>

<span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">N</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>

<span class="nb">print</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">N</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>[[0. 0. 4.]
 [0. 4. 0.]
 [0. 7. 0.]]
[[0. 0. 2.]
 [0. 4. 0.]
 [0. 7. 0.]]


[[nan nan  2.]
 [nan  1. nan]
 [nan  1. nan]]
[[0. 0. 2.]
 [0. 1. 0.]
 [0. 1. 0.]]
</code></pre>
</div>

<p>Mesafe</p>

<p>Devam etmeden önce önemli bir konuya değinelim, bu da mesafe
kavramı. K-Means kümelemesi Öklit (Euclidian) mesafe kullanır, bu
mesafenin sıfır değerlerini nasıl kullandığına dikkat etmek
gerekir. Sıfır değeri tabii ki bizim seçimlerimiz bağlamında
"seyredilmemiş" demektir. Fakat Öklitsel mesafe hesaplıyorsam, mesela
benim üç boyutlu vektörüm x1,y1,z1 ile başka bir x2,y2,z2 vektör
arasında bu hesap (x1-x2) karesi artı (y1-y2) karesi vs diye devam
ediyor. Sonra bu toplamın karekökü alınıyor. Fakat eğer bende x filmi
seyredilmemişse, yoğun matris bağlamında orada sıfır vardır, ama küme
merkezine uzaklık hesaplıyorsam bu merkezin x2 (ve diğer
y2,z2).. öğesinde muhakkak bir değer vardır. Bu mevcut değere uzaklık
hesaplarsam bendeki sıfır değeri mevcut değeri beni uzakmışım gibi
gösterecektir. Fakat belki o filmi seyretsem belli bir kümenin
değerine yakın not verirdim, o zaman ona yakın gözükürdüm. Demek ki
bendeki boş değerler mesafesel olarak problem çıkartabilir. İşte bu
sebeple <code>KMeans2Job</code> kodunda mesafe hesaplarken <code>vec[vec&gt;0] -
self.means[:,vec&gt;0]</code> kodunu kullandık, yani <code>vec</code> üzerinde sıfır
<em>olmayan</em> değerlerin <code>self.means</code> ile mesafesine bakılıyor. Diğerleri
Öklit mesafesine dahil edilmiyor.</p>

<p>Kodu işletelim, şimdilik iki kod parçasını tek bir döngü içinde çağıracağız,</p>

<div class="codehilite">
<pre><span></span><code><span class="n">process</span><span class="p">(</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/ratings-json.csv&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hookobj</span> <span class="o">=</span> <span class="n">KMeans1Job</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">process</span><span class="p">(</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/ratings-json.csv&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hookobj</span> <span class="o">=</span> <span class="n">KMeans2Job</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>KMeans1Job tamam
KMeans2Job tamam
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">ls</span> <span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>b&#39;total 2156
   8 cluster-assignments-0.npz
   8 cluster-assignments-1.npz
 384 means-1.npz
 140 movie_id_int.json
 344 movie_title_int.json
1272 ratings-json.csv
</code></pre>
</div>

<p>Görüldüğü gibi <code>-1.npz</code> ile biten dosyalar yaratıldı, bu dosyaların
1'inci döngünün sonuçları. Boyutlara bakıyoruz,</p>

<div class="codehilite">
<pre><span></span><code><span class="n">ca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;/cluster-assignments-1.npz&quot;</span><span class="p">)[</span><span class="s1">&#39;arr_0&#39;</span><span class="p">]</span>
<span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;/means-1.npz&quot;</span><span class="p">)[</span><span class="s1">&#39;arr_0&#39;</span><span class="p">]</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;atamalar&#39;</span><span class="p">,</span><span class="n">ca</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;kume merkezleri&#39;</span><span class="p">,</span><span class="n">means</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>atamalar (610,)
kume merkezleri (5, 9742)
</code></pre>
</div>

<h3>Kullanım</h3>

<p>Döngüyü birkaç kez işletelim,</p>

<div class="codehilite">
<pre><span></span><code><span class="k">for</span> <span class="n">iter_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">process</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">fin1</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hookobj</span> <span class="o">=</span> <span class="n">KMeans1Job</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">iter_no</span><span class="p">))</span>
    <span class="n">process</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">fin1</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hookobj</span> <span class="o">=</span> <span class="n">KMeans2Job</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">iter_no</span><span class="p">))</span>
</code></pre>
</div>

<p>Bunu yapmak sonuçları iyileştirir. Kendi seçtiğimiz bazı filmlere
notlar verelim, ve bu seçimlere yakın olan kümeyi bulalım,</p>

<div class="codehilite">
<pre><span></span><code><span class="n">picks</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">movie,rating</span>
<span class="s2">Swordfish (2001),5</span>
<span class="s2">&quot;Rock, The (1996)&quot;,5</span>
<span class="s2">Dunkirk (2017),2</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">io</span>

<span class="n">dt</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;/movie_title_int.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outdir</span> <span class="o">+</span> <span class="s2">&quot;/means-9.npz&quot;</span><span class="p">)[</span><span class="s1">&#39;arr_0&#39;</span><span class="p">]</span>
<span class="n">picks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">picks</span><span class="p">),</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mov</span><span class="p">,</span><span class="n">rating</span> <span class="ow">in</span> <span class="n">picks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">mov</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
        <span class="n">vec</span><span class="p">[</span><span class="n">dt</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">mov</span><span class="p">)]]</span> <span class="o">=</span> <span class="n">rating</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span>
<span class="n">nearest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">lin</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="n">vec</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">means</span><span class="p">[:,</span><span class="n">vec</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;en yakin&#39;</span><span class="p">,</span> <span class="n">nearest</span><span class="p">)</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>en yakin 3
</code></pre>
</div>

<p>En yakın kümeyi bulduk. Şimdi not verdiğimiz her filmin tüm kümelerde
ortalama nasıl notlanmış olduğuna bakalım, acaba bizim notlarla uyumlu
mu?</p>

<div class="codehilite">
<pre><span></span><code><span class="n">means</span><span class="p">[:,</span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;Swordfish (2001)&#39;</span><span class="p">]]</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>Out[1]: array([2.25      , 3.5       , 3.33333333, 3.2       , 2.875     ])
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">means</span><span class="p">[:,</span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;Rock, The (1996)&#39;</span><span class="p">]]</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>Out[1]: array([3.8125    , 3.3125    , 3.58064516, 3.85714286, 3.5       ])
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="n">means</span><span class="p">[:,</span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;Dunkirk (2017)&#39;</span><span class="p">]]</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code>Out[1]: array([3.375     , 3.75      , 5.        , 3.16666667, 3.        ])
</code></pre>
</div>

<p>Uyumlu gözüküyor.</p>

<p>Paralel işletme kısmını ödev bırakıyoruz, burada eklenecek kodların
genel yaklaşımından bahsedelim. Ortalama için her paralel işletici
kullanıcıların bir kısmını işler, ve o kısımla ilgili küme
ortalamalarını hesaplar. İki tane süreç iki tane K x M ortalama
yaratır, o zaman her döngüde paralel süreç ortalamaları bitince seri
şekilde (paralel değil) bu ortalamaların ortalamaları alınır, o
döngünün nihai ortalaması bu olur.</p>

<p>Küme ataması daha bariz, çünkü zaten kullanıcı bazlı hesaplanan ve
atanan bir değer, eh bizim paralel yaklaşım da kullanıcı bazlı
işbölümü yaptığına göre burada tek yapılması gereken paralel atama
bitince her süreçten gelen sonuçları birleştirmektir, yani ucu uca
getirip yapıştırmak (concatanate), bu kadar.</p>

<p>Not: K-Means algoritmasi nereden başlanırsa başlansın yakınsama
yapabilen (convergent) bir algoritmadır, bir optimal noktaya muhakkak
ulaşır. Fakat bu optimal nokta yerel (local) optima olabilir, genel,
kullanışlı optima olmayabilir. Bu durumda farklı yerlerden (birkaç
farklı rasgele noktadan) algoritmaya birkaç kere işletip nereye
ulaştığına bakmak bir ek yöntem olabilir.</p>

<p>Kaynaklar</p>

<p>[1] https://grouplens.org/datasets/movielens/</p>

<p>[2] <a href="../../../stat/stat_137_collab/toplu_tavsiye__collaborative_filtering__filmler_svd_ile_boyut_indirgeme.html">Toplu Tavsiye (Collaborative Filtering), Filmler, SVD ile Boyut İndirgeme</a></p>

<p>[3] <a href="../../../algs/algs_080_kmeans/kmeans_kumeleme_metodu.html">K-Means Kümeleme Metodu</a> </p>

<p>[4] <a href="../../2022/11/paralel-veri-analizi-istatistik.html">Paralel Veri Analizi, İstatistik</a></p>

          <br/><a href="../index.html">Yukarı</a>
        </section>          
      </div>
    </body>
</html>
